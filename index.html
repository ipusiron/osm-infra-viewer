<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMã‚¤ãƒ³ãƒ•ãƒ©å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ï¼ˆOSM Infrastructure Viewerï¼‰</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .map-container {
            margin: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        #map {
            height: 600px;
            width: 100%;
        }

        .status {
            margin: 1rem;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .legend {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .marker-surveillance { background: #e74c3c; }
        .marker-tower { background: #3498db; }
        .marker-wifi { background: #f39c12; }

        /* ã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .marker-cluster {
            background: rgba(102, 126, 234, 0.6);
            border: 3px solid rgba(102, 126, 234, 0.8);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .marker-cluster-small {
            width: 40px;
            height: 40px;
            line-height: 37px;
        }

        .marker-cluster-medium {
            width: 50px;
            height: 50px;
            line-height: 47px;
            font-size: 16px;
        }

        .marker-cluster-large {
            width: 60px;
            height: 60px;
            line-height: 57px;
            font-size: 18px;
        }

        /* ã‚¤ãƒ³ãƒ•ãƒ©ç¨®åˆ¥ã”ã¨ã®ã‚¯ãƒ©ã‚¹ã‚¿è‰² */
        .cluster-surveillance {
            background: rgba(231, 76, 60, 0.6);
            border-color: rgba(231, 76, 60, 0.8);
        }

        .cluster-tower {
            background: rgba(52, 152, 219, 0.6);
            border-color: rgba(52, 152, 219, 0.8);
        }

        .cluster-wifi {
            background: rgba(243, 156, 18, 0.6);
            border-color: rgba(243, 156, 18, 0.8);
        }

        .cluster-mixed {
            background: rgba(149, 165, 166, 0.6);
            border-color: rgba(149, 165, 166, 0.8);
        }

        #debug-controls {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed #95a5a6;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        #debug-controls::before {
            content: "ğŸ”§ é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«:";
            font-weight: 600;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .dev-mode-btn {
            font-size: 0.85rem !important;
            padding: 0.6rem 1.2rem !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .dev-mode-btn:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .controls {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            .checkbox-group {
                gap: 0.5rem;
            }
            
            #debug-controls {
                margin-top: 0.8rem;
                padding: 0.8rem;
                gap: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
            }
            
            #map {
                height: 500px;
            }
            
            .legend {
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ OSMã‚¤ãƒ³ãƒ•ãƒ©å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ï¼ˆOSM Infrastructure Viewerï¼‰</h1>
        <p>OpenStreetMapã®ã‚¤ãƒ³ãƒ•ãƒ©ç³»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆCCTVã€åŸºåœ°å±€ã€Wi-Fiï¼‰ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>è¡¨ç¤ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="surveillance" value="surveillance" checked>
                    <label for="surveillance">CCTVã‚«ãƒ¡ãƒ©</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tower" value="tower" checked>
                    <label for="tower">æºå¸¯åŸºåœ°å±€</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="wifi" value="wifi" checked>
                    <label for="wifi">Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ</label>
                </div>
            </div>
        </div>
        <button class="search-btn" onclick="searchInfrastructure()">ğŸ” æ¤œç´¢</button>
        <button class="search-btn" onclick="showClusterInfo()" style="background: #8e44ad;">ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±</button>
        <button class="search-btn dev-mode-btn" onclick="toggleDebugMode()" style="background: #6c757d;">âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</button>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º -->
        <div id="debug-controls" style="display: none;">
            <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
            <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
            <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="legend">
        <h3>å‡¡ä¾‹</h3>
        <div class="legend-item">
            <div class="legend-marker marker-surveillance"></div>
            <span>CCTVã‚«ãƒ¡ãƒ© (man_made=surveillance)</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker marker-tower"></div>
            <span>æºå¸¯åŸºåœ°å±€ (man_made=communications_tower)</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker marker-wifi"></div>
            <span>Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ (internet_access=wlan)</span>
        </div>
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½</strong><br>
            å¯†é›†ã‚¨ãƒªã‚¢ã§ã¯è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¦è©³ç´°è¡¨ç¤ºã€‚<br>
            <span style="color: #e74c3c;">â—</span> ç›£è¦–ã‚«ãƒ¡ãƒ©ä¸»ä½“
            <span style="color: #3498db;">â—</span> åŸºåœ°å±€ä¸»ä½“
            <span style="color: #f39c12;">â—</span> Wi-Fiä¸»ä½“
            <span style="color: #95a5a6;">â—</span> æ··åœ¨
        </div>
    </div>

    <div style="margin-top: 30px; padding: 15px; text-align: center; border-top: 1px solid #000000; color: #6c757d;">
        ğŸ”— GitHubãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ï¼ˆ<a href="https://github.com/ipusiron/osm-infra-viewer" target="_blank" style="color: #007bff; text-decoration: none;">ipusiron/osm-infra-viewer</a>ï¼‰
        <br>
        <small style="font-size: 0.7rem; color: #aaa; margin-top: 5px; display: inline-block;">
            ğŸ’¡ ä¸Šéƒ¨ã®ã€Œâš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™
        </small>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet MarkerCluster JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    
    <script>
        // åœ°å›³ã®åˆæœŸåŒ–
        let map = L.map('map').setView([35.6762, 139.6503], 13); // æ±äº¬é§…ä»˜è¿‘

        // OpenStreetMapã‚¿ã‚¤ãƒ«è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
        let markersGroup = L.markerClusterGroup({
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®è¨­å®š
            maxClusterRadius: 50, // ã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã™ã‚‹æœ€å¤§è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            spiderfyOnMaxZoom: true, // æœ€å¤§ã‚ºãƒ¼ãƒ æ™‚ã«ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼è¡¨ç¤º
            showCoverageOnHover: false, // ãƒ›ãƒãƒ¼æ™‚ã®ç¯„å›²è¡¨ç¤ºã‚’ç„¡åŠ¹
            zoomToBoundsOnClick: true, // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ºãƒ¼ãƒ 
            disableClusteringAtZoom: 18, // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«18ä»¥ä¸Šã§ã‚¯ãƒ©ã‚¹ã‚¿ç„¡åŠ¹
            
            // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ã‚¿ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
            iconCreateFunction: function(cluster) {
                const markers = cluster.getAllChildMarkers();
                let surveillanceCount = 0;
                let towerCount = 0;
                let wifiCount = 0;
                
                // å„ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                markers.forEach(marker => {
                    const type = marker.options.infraType;
                    if (type === 'surveillance') surveillanceCount++;
                    else if (type === 'tower') towerCount++;
                    else if (type === 'wifi') wifiCount++;
                });
                
                const childCount = cluster.getChildCount();
                let clusterClass = 'marker-cluster-';
                let infraClass = 'cluster-mixed';
                
                // ã‚µã‚¤ã‚ºã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
                if (childCount < 10) {
                    clusterClass += 'small';
                } else if (childCount < 50) {
                    clusterClass += 'medium';
                } else {
                    clusterClass += 'large';
                }
                
                // ä¸»è¦ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
                const maxCount = Math.max(surveillanceCount, towerCount, wifiCount);
                if (surveillanceCount === maxCount && surveillanceCount > childCount * 0.6) {
                    infraClass = 'cluster-surveillance';
                } else if (towerCount === maxCount && towerCount > childCount * 0.6) {
                    infraClass = 'cluster-tower';
                } else if (wifiCount === maxCount && wifiCount > childCount * 0.6) {
                    infraClass = 'cluster-wifi';
                }
                
                return new L.DivIcon({
                    html: `<div><span>${childCount}</span></div>`,
                    className: `marker-cluster ${clusterClass} ${infraClass}`,
                    iconSize: new L.Point(40, 40)
                });
            }
        }).addTo(map);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Overpass APIã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
        function buildOverpassQuery(bounds) {
            const selectedTypes = [];
            
            if (document.getElementById('surveillance').checked) {
                selectedTypes.push('surveillance');
            }
            if (document.getElementById('tower').checked) {
                selectedTypes.push('tower');
            }
            if (document.getElementById('wifi').checked) {
                selectedTypes.push('wifi');
            }

            if (selectedTypes.length === 0) {
                return null;
            }

            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query = '[out:json][timeout:25];\n(\n';
            
            selectedTypes.forEach(type => {
                if (type === 'surveillance') {
                    // ç›£è¦–ã‚«ãƒ¡ãƒ© - ã‚ˆã‚Šåºƒç¯„å›²ãªã‚¯ã‚¨ãƒª
                    query += `  node["man_made"="surveillance"](${bbox});\n`;
                    query += `  way["man_made"="surveillance"](${bbox});\n`;
                    query += `  node["surveillance"](${bbox});\n`;
                } else if (type === 'tower') {
                    // é€šä¿¡å¡”ãƒ»åŸºåœ°å±€
                    query += `  node["man_made"="communications_tower"](${bbox});\n`;
                    query += `  node["man_made"="tower"]["tower:type"="communication"](${bbox});\n`;
                    query += `  node["man_made"="mast"](${bbox});\n`;
                } else if (type === 'wifi') {
                    // Wi-Fié–¢é€£
                    query += `  node["internet_access"="wlan"](${bbox});\n`;
                    query += `  node["amenity"="internet_cafe"](${bbox});\n`;
                    query += `  node["amenity"="cafe"]["internet_access"="wlan"](${bbox});\n`;
                }
            });
            
            query += ');\nout center meta;';
            
            return query;
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®š
        function getMarkerInfo(element) {
            const tags = element.tags || {};
            
            if (tags.man_made === 'surveillance') {
                return {
                    color: '#e74c3c',
                    icon: 'ğŸ“¹',
                    type: 'CCTVã‚«ãƒ¡ãƒ©',
                    infraType: 'surveillance'
                };
            } else if (tags.man_made === 'communications_tower') {
                return {
                    color: '#3498db',
                    icon: 'ğŸ“¡',
                    type: 'æºå¸¯åŸºåœ°å±€',
                    infraType: 'tower'
                };
            } else if (tags.internet_access === 'wlan') {
                return {
                    color: '#f39c12',
                    icon: 'ğŸ“¶',
                    type: 'Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ',
                    infraType: 'wifi'
                };
            }
            
            return {
                color: '#95a5a6',
                icon: 'ğŸ“',
                type: 'ãã®ä»–',
                infraType: 'other'
            };
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’ç”Ÿæˆ
        function generatePopupContent(element, markerInfo) {
            const tags = element.tags || {};
            let content = `<div style="min-width: 200px;">`;
            content += `<h4 style="margin: 0 0 10px 0; color: ${markerInfo.color};">${markerInfo.icon} ${markerInfo.type}</h4>`;
            
            // é‡è¦ãªå±æ€§ã‚’å„ªå…ˆè¡¨ç¤º
            const importantKeys = ['name', 'operator', 'surveillance:type', 'tower:type', 'height', 'description'];
            const displayedKeys = new Set();
            
            importantKeys.forEach(key => {
                if (tags[key]) {
                    content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
                    displayedKeys.add(key);
                }
            });
            
            // ãã®ä»–ã®å±æ€§
            const otherTags = Object.keys(tags).filter(key => !displayedKeys.has(key));
            if (otherTags.length > 0) {
                content += `<hr style="margin: 10px 0;">`;
                otherTags.forEach(key => {
                    if (key !== 'man_made' && key !== 'internet_access') {
                        content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
                    }
                });
            }
            
            content += `<hr style="margin: 10px 0;">`;
            content += `<div style="font-size: 0.8em; color: #666;">`;
            content += `<div>ID: ${element.id}</div>`;
            if (element.lat && element.lon) {
                content += `<div>ä½ç½®: ${element.lat.toFixed(6)}, ${element.lon.toFixed(6)}</div>`;
            }
            content += `</div></div>`;
            
            return content;
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        function addMarkersToMap(data) {
            console.log('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ é–‹å§‹');
            markersGroup.clearLayers();
            let count = 0;
            let skippedCount = 0;

            if (!data.elements || data.elements.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                showStatus('ã“ã®ç¯„å›²ã«ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                return;
            }

            data.elements.forEach((element, index) => {
                let lat, lon;
                
                if (element.lat && element.lon) {
                    lat = element.lat;
                    lon = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lon = element.center.lon;
                } else if (element.geometry && element.geometry.length > 0) {
                    lat = element.geometry[0].lat;
                    lon = element.geometry[0].lon;
                } else {
                    console.log(`âš ï¸ åº§æ¨™ãªã— [${index}]:`, element);
                    skippedCount++;
                    return; // åº§æ¨™ãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                const markerInfo = getMarkerInfo(element);
                console.log(`ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ [${index}]: ${markerInfo.type} at ${lat}, ${lon}`);
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: markerInfo.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    infraType: markerInfo.infraType // ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç”¨ã®ã‚¿ã‚¤ãƒ—æƒ…å ±
                });

                const popupContent = generatePopupContent(element, markerInfo);
                marker.bindPopup(popupContent);
                
                markersGroup.addLayer(marker);
                count++;
            });

            console.log(`âœ… ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ å®Œäº†: ${count}å€‹è¡¨ç¤º, ${skippedCount}å€‹ã‚¹ã‚­ãƒƒãƒ—`);
            
            if (count === 0) {
                showStatus(`ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã—ãŸãŒã€è¡¨ç¤ºå¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå–å¾—è¦ç´ æ•°: ${data.elements.length}ï¼‰`, 'error');
            } else {
                showStatus(`${count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
            }
        }

        // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’æ¤œç´¢
        async function searchInfrastructure() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            if (!query) {
                showStatus('æ¤œç´¢ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            console.log('ğŸ” æ¤œç´¢é–‹å§‹');
            console.log('æ¤œç´¢ç¯„å›²:', bounds);
            console.log('ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:', map.getZoom());
            console.log('Overpassã‚¯ã‚¨ãƒª:', query);

            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'loading');
            
            const searchBtn = document.querySelector('.search-btn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'æ¤œç´¢ä¸­...';

            try {
                //è¤‡æ•°ã®Overpass APIã‚µãƒ¼ãƒãƒ¼ã‚’è©¦ã™
                const apiUrls = [
                    'https://overpass-api.de/api/interpreter',
                    'https://lz4.overpass-api.de/api/interpreter',
                    'https://z.overpass-api.de/api/interpreter'
                ];
                
                let response;
                let lastError;
                
                for (const apiUrl of apiUrls) {
                    try {
                        console.log(`ğŸŒ APIè©¦è¡Œ: ${apiUrl}`);
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: 'data=' + encodeURIComponent(query)
                        });
                        
                        if (response.ok) {
                            console.log(`âœ… APIæˆåŠŸ: ${apiUrl}`);
                            break;
                        } else {
                            console.log(`âŒ APIå¤±æ•—: ${apiUrl}, status: ${response.status}`);
                            lastError = new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.log(`âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${apiUrl}`, error);
                        lastError = error;
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw lastError || new Error('ã™ã¹ã¦ã®APIã‚µãƒ¼ãƒãƒ¼ã§å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                console.log('ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
                console.log('è¦ç´ æ•°:', data.elements ? data.elements.length : 0);
                
                addMarkersToMap(data);
                
            } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                showStatus('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ğŸ” æ¤œç´¢';
            }
        }

        // åœ°å›³ç§»å‹•æ™‚ã®å‡¦ç†
        map.on('moveend', function() {
            const zoom = map.getZoom();
            if (zoom < 10) {
                showStatus('è©³ç´°ãªæ¤œç´¢ã«ã¯åœ°å›³ã‚’ã‚ˆã‚Šæ‹¡å¤§ã—ã¦ãã ã•ã„ï¼ˆã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«10ä»¥ä¸Šæ¨å¥¨ï¼‰', 'error');
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        window.addEventListener('load', function() {
            initializeDebugMode(); // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
            showStatus('åœ°å›³ã‚’ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ ã—ã¦ã‹ã‚‰æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'success');
        });

        // ç°¡å˜ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        async function testSimpleQuery() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªï¼ˆATMã‚’æ¤œç´¢ï¼‰
            const simpleQuery = `[out:json][timeout:25];
(
  node["amenity"="atm"](${bbox});
  node["amenity"="bank"](${bbox});
  node["shop"="convenience"](${bbox});
);
out center meta;`;

            console.log('ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆé–‹å§‹');
            console.log('ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒª:', simpleQuery);
            
            showStatus('ç°¡å˜ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ï¼ˆATMãƒ»éŠ€è¡Œãƒ»ã‚³ãƒ³ãƒ“ãƒ‹ã‚’æ¤œç´¢ï¼‰...', 'loading');
            
            try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(simpleQuery)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ:', data);
                
                markersGroup.clearLayers();
                let count = 0;
                
                data.elements.forEach(element => {
                    if (element.lat && element.lon) {
                        const marker = L.circleMarker([element.lat, element.lon], {
                            radius: 6,
                            fillColor: '#27ae60',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                        
                        const tags = element.tags || {};
                        const name = tags.name || tags.amenity || tags.shop || 'Unknown';
                        marker.bindPopup(`<strong>ãƒ†ã‚¹ãƒˆçµæœ</strong><br>ç¨®é¡: ${name}<br>ID: ${element.id}`);
                        markersGroup.addLayer(marker);
                        count++;
                    }
                });
                
                showStatus(`ãƒ†ã‚¹ãƒˆæˆåŠŸï¼${count}å€‹ã®ãƒ†ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º`, 'success');
                
                // Overpass Turboãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(simpleQuery)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('ğŸ”— Overpass Turboã§ç¢ºèª:', turboUrl);
                
            } catch (error) {
                console.error('ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message, 'error');
            }
        }

        // ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±è¡¨ç¤ºï¼ˆé–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ï¼‰
        function showClusterInfo() {
            const totalMarkers = markersGroup.getLayers().length;
            const clusters = [];
            
            // è¡¨ç¤ºä¸­ã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åé›†
            markersGroup.eachLayer(function(layer) {
                if (layer instanceof L.MarkerCluster) {
                    const markers = layer.getAllChildMarkers();
                    let surveillance = 0, tower = 0, wifi = 0, other = 0;
                    
                    markers.forEach(marker => {
                        const type = marker.options.infraType;
                        if (type === 'surveillance') surveillance++;
                        else if (type === 'tower') tower++;
                        else if (type === 'wifi') wifi++;
                        else other++;
                    });
                    
                    clusters.push({
                        count: markers.length,
                        surveillance, tower, wifi, other,
                        bounds: layer.getBounds()
                    });
                }
            });
            
            console.log('ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æçµæœ');
            console.log('ç·ãƒãƒ¼ã‚«ãƒ¼æ•°:', totalMarkers);
            console.log('ã‚¯ãƒ©ã‚¹ã‚¿æ•°:', clusters.length);
            console.log('å¹³å‡ã‚¯ãƒ©ã‚¹ã‚¿ã‚µã‚¤ã‚º:', clusters.length > 0 ? (totalMarkers / clusters.length).toFixed(1) : 0);
            console.log('ã‚¯ãƒ©ã‚¹ã‚¿è©³ç´°:', clusters);
            
            // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            let totalSurveillance = 0, totalTower = 0, totalWifi = 0, totalOther = 0;
            markersGroup.eachLayer(function(layer) {
                if (layer.options && layer.options.infraType) {
                    const type = layer.options.infraType;
                    if (type === 'surveillance') totalSurveillance++;
                    else if (type === 'tower') totalTower++;
                    else if (type === 'wifi') totalWifi++;
                    else totalOther++;
                }
            });
            
            const clusteringRatio = clusters.length > 0 ? ((totalMarkers - clusters.length) / totalMarkers * 100).toFixed(1) : 0;
            
            showStatus(`ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æå®Œäº† - ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç‡: ${clusteringRatio}%`, 'success');
            
            alert(`ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æçµæœ\n\nç·ãƒãƒ¼ã‚«ãƒ¼æ•°: ${totalMarkers}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“¹ CCTVã‚«ãƒ¡ãƒ©: ${totalSurveillance}\nğŸ“¡ æºå¸¯åŸºåœ°å±€: ${totalTower}\nğŸ“¶ Wi-Fi: ${totalWifi}\nğŸ“ ãã®ä»–: ${totalOther}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚¿æ•°: ${clusters.length}\nã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åŠ¹ç‡: ${clusteringRatio}%\n\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }

        // ãƒ†ã‚¹ãƒˆåœ°ç‚¹ã«ã‚¸ãƒ£ãƒ³ãƒ—
        function jumpToTestLocation() {
            // ç›£è¦–ã‚«ãƒ¡ãƒ©ã‚„é€šä¿¡è¨­å‚™ãŒå¤šã„åœ°åŸŸã‚’é¸æŠ
            const testLocations = [
                { name: 'ãƒ­ãƒ³ãƒ‰ãƒ³å¸‚å†…ï¼ˆç›£è¦–ã‚«ãƒ¡ãƒ©å¤šæ•°ï¼‰', lat: 51.5074, lng: -0.1278, zoom: 16 },
                { name: 'ãƒ™ãƒ«ãƒªãƒ³ä¸­å¤®é§…', lat: 52.5251, lng: 13.3693, zoom: 17 },
                { name: 'ãƒ‘ãƒª ã‚·ãƒ£ãƒ³ã‚¼ãƒªã‚¼', lat: 48.8738, lng: 2.2950, zoom: 17 },
                { name: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ ã‚¿ã‚¤ãƒ ã‚ºã‚¹ã‚¯ã‚¨ã‚¢', lat: 40.7580, lng: -73.9855, zoom: 17 },
                { name: 'æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«äº¤å·®ç‚¹', lat: 35.6595, lng: 139.7006, zoom: 18 },
                { name: 'æ–°å®¿é§…æ±å£', lat: 35.6896, lng: 139.7006, zoom: 17 }
            ];
            
            const location = testLocations[Math.floor(Math.random() * testLocations.length)];
            map.setView([location.lat, location.lng], location.zoom);
            showStatus(`${location.name}ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã—ãŸ`, 'success');
            console.log(`ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹: ${location.name} (${location.lat}, ${location.lng})`);
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            console.log('=== ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('ç¾åœ¨ä½ç½®:', map.getCenter());
            console.log('ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:', map.getZoom());
            console.log('æ¤œç´¢ç¯„å›²:', bounds);
            console.log('ç¯„å›²ã‚µã‚¤ã‚º (ç·¯åº¦):', bounds.getNorth() - bounds.getSouth());
            console.log('ç¯„å›²ã‚µã‚¤ã‚º (çµŒåº¦):', bounds.getEast() - bounds.getWest());
            console.log('é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:', {
                surveillance: document.getElementById('surveillance').checked,
                tower: document.getElementById('tower').checked,
                wifi: document.getElementById('wifi').checked
            });
            console.log('Overpassã‚¯ã‚¨ãƒª:', query);
            console.log('ç¾åœ¨ã®ãƒãƒ¼ã‚«ãƒ¼æ•°:', markersGroup.getLayers().length);
            console.log('ãƒ–ãƒ©ã‚¦ã‚¶:', navigator.userAgent);
            console.log('HTTPS:', location.protocol === 'https:');
            
            // Overpass Turboãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            if (query) {
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('ğŸ”— Overpass Turboã§ç¢ºèª:', turboUrl);
            }
            console.log('===================');
            
            const turboLink = query ? `\n\nğŸ”— Overpass Turboã§ãƒ†ã‚¹ãƒˆ:\nhttps://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}` : '';
            
            alert(`ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚\n\nç¾åœ¨åœ°: ${map.getCenter().lat.toFixed(4)}, ${map.getCenter().lng.toFixed(4)}\nã‚ºãƒ¼ãƒ : ${map.getZoom()}\nãƒãƒ¼ã‚«ãƒ¼æ•°: ${markersGroup.getLayers().length}\n\nF12ã‚­ãƒ¼ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚${turboLink}`);
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
        let isDebugModeActive = false;

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleDebugMode() {
            isDebugModeActive = !isDebugModeActive;
            const debugControls = document.getElementById('debug-controls');
            const toggleButton = event.target;
            
            if (isDebugModeActive) {
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
                `;
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ ON';
                toggleButton.style.background = '#28a745';
                console.log('ğŸ”§ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ - ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™', 'success');
            } else {
                debugControls.style.display = 'none';
                debugControls.innerHTML = '';
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰';
                toggleButton.style.background = '#6c757d';
                console.log('ğŸ”’ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ç¢ºèªã¨åˆæœŸåŒ–
        function initializeDebugMode() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚‚å¯¾å¿œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const isDebugMode = urlParams.get('debug') === 'true';
            
            if (isDebugMode) {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµŒç”±ã®å ´åˆã¯è‡ªå‹•ã§é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
                // toggleDebugModeé–¢æ•°ã‚’å‘¼ã³å‡ºã•ãšã«ç›´æ¥è¨­å®š
                isDebugModeActive = true;
                const debugControls = document.getElementById('debug-controls');
                const toggleButton = document.querySelector('.dev-mode-btn');
                
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
                    <button class="search-btn" onclick="showClusterInfo()" style="background: #8e44ad;">ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±</button>
                `;
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ ON';
                toggleButton.style.background = '#28a745';
                console.log('ğŸ”§ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼ˆURLçµŒç”±ï¼‰');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ï¼ˆURLçµŒç”±ï¼‰', 'success');
            }
        }

        // ä½ç½®æƒ…å ±å–å¾—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            // ä½ç½®æƒ…å ±å–å¾—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000 // 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 15);
                    showStatus('ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§åœ°å›³ã‚’ç§»å‹•ã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚';
                            break;
                        default:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                            break;
                    }
                    console.log('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', errorMessage);
                    // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã›ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬ï¼‰ã§é–‹å§‹
                },
                options
            );
        }

        // ä½ç½®æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ
        initializeLocation();
    </script>
</body>
</html>

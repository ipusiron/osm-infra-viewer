<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMインフラ可視化ツール - 包括的インフラマッピング</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .checkbox-groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .checkbox-group {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.8rem;
            background: #f8f9fa;
        }

        .checkbox-group-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #dee2e6;
        }

        .checkbox-group-items {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .map-container {
            margin: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        #map {
            height: 600px;
            width: 100%;
        }

        .status {
            margin: 1rem;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .legend {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .marker-surveillance { background: #e74c3c; }
        .marker-tower { background: #3498db; }
        .marker-wifi { background: #f39c12; }
        .marker-police { background: #c0392b; }
        .marker-emergency { background: #e67e22; }
        .marker-antenna { background: #9b59b6; }
        .marker-substation { background: #f1c40f; }
        .marker-power_pole { background: #d68910; }
        .marker-generator { background: #28b463; }
        .marker-traffic_signals { background: #dc143c; }
        .marker-speed_camera { background: #8b0000; }
        .marker-fuel_station { background: #ff6b6b; }
        .marker-atm { background: #2ecc71; }
        .marker-post_box { background: #e74c3c; }
        .marker-waste_disposal { background: #7f8c8d; }

        /* ポップアップのカスタムスタイル */
        .leaflet-popup-content {
            width: auto !important;
            max-width: 400px !important;
            min-width: 300px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin: -10px -10px 15px -10px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 16px;
        }

        .popup-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }

        .popup-table th {
            background: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            width: 35%;
        }

        .popup-table td {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            color: #212529;
            word-break: break-word;
        }

        .popup-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .popup-table tr:hover {
            background: #e9ecef;
        }

        .popup-metadata {
            font-size: 12px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
            margin-top: 15px;
        }

        .popup-coordinates {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .popup-tag-category {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
        }

        .popup-external-links {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .popup-external-links a {
            display: inline-block;
            margin-right: 10px;
            padding: 4px 8px;
            background: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }

        .popup-external-links a:hover {
            background: #138496;
        }
        .marker-cluster {
            background: rgba(102, 126, 234, 0.6);
            border: 3px solid rgba(102, 126, 234, 0.8);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .marker-cluster-small {
            width: 40px;
            height: 40px;
            line-height: 37px;
        }

        .marker-cluster-medium {
            width: 50px;
            height: 50px;
            line-height: 47px;
            font-size: 16px;
        }

        .marker-cluster-large {
            width: 60px;
            height: 60px;
            line-height: 57px;
            font-size: 18px;
        }

        /* インフラ種別ごとのクラスタ色 */
        .cluster-surveillance {
            background: rgba(231, 76, 60, 0.6);
            border-color: rgba(231, 76, 60, 0.8);
        }

        .cluster-tower {
            background: rgba(52, 152, 219, 0.6);
            border-color: rgba(52, 152, 219, 0.8);
        }

        .cluster-wifi {
            background: rgba(243, 156, 18, 0.6);
            border-color: rgba(243, 156, 18, 0.8);
        }

        .cluster-mixed {
            background: rgba(149, 165, 166, 0.6);
            border-color: rgba(149, 165, 166, 0.8);
        }

        #debug-controls {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed #95a5a6;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        #debug-controls::before {
            content: "🔧 開発者ツール:";
            font-weight: 600;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .dev-mode-btn {
            font-size: 0.85rem !important;
            padding: 0.6rem 1.2rem !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .dev-mode-btn:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .controls {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            .checkbox-groups-container {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .checkbox-group {
                padding: 0.6rem;
            }
            
            .checkbox-group-items {
                gap: 0.2rem;
            }
            
            #debug-controls {
                margin-top: 0.8rem;
                padding: 0.8rem;
                gap: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
            }
            
            #map {
                height: 500px;
            }
            
            .legend {
                margin: 0.5rem;
            }
            
            .legend > div[style*="grid"] {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* モバイル用ポップアップ調整 */
            .leaflet-popup-content {
                max-width: 280px !important;
                min-width: 250px !important;
            }
            
            .popup-table {
                font-size: 12px;
            }
            
            .popup-table th,
            .popup-table td {
                padding: 6px 8px;
            }
            
            .popup-external-links a {
                display: block;
                margin: 5px 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🗺️ OSMインフラ可視化ツール（OSM Infrastructure Viewer）</h1>
        <p>OpenStreetMapの多様なインフラオブジェクト（監視、通信、電力、交通等）を可視化するツール</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>表示オブジェクト:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="surveillance" value="surveillance" checked>
                    <label for="surveillance">CCTVカメラ</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tower" value="tower" checked>
                    <label for="tower">携帯基地局</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="wifi" value="wifi" checked>
                    <label for="wifi">Wi-Fiホットスポット</label>
                </div>
            </div>
        </div>
        <button class="search-btn" onclick="searchInfrastructure()">🔍 検索</button>
        <button class="search-btn" onclick="showClusterInfo()" style="background: #8e44ad;">📊 クラスタ情報</button>
        <button class="search-btn" onclick="showExportOptions()" style="background: #17a2b8;">💾 データ出力</button>
        <button class="search-btn dev-mode-btn" onclick="toggleDebugMode()" style="background: #6c757d;">⚙️ 開発者モード</button>
        
        <!-- デバッグモード時のみ表示 -->
        <div id="debug-controls" style="display: none;">
            <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">🔧 デバッグ情報</button>
            <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">📍 テスト地点</button>
            <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">🧪 簡単テスト</button>
        </div>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="legend">
        <h3>凡例（主要オブジェクト）</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
            <div>
                <strong>🔒 監視・セキュリティ</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-surveillance"></div>
                    <span>📹 CCTVカメラ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-police"></div>
                    <span>🚓 警察関連</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-emergency"></div>
                    <span>🆘 緊急電話</span>
                </div>
            </div>
            
            <div>
                <strong>📡 通信・ネットワーク</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-tower"></div>
                    <span>📡 携帯基地局</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-wifi"></div>
                    <span>📶 Wi-Fi</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-antenna"></div>
                    <span>📻 アンテナ</span>
                </div>
            </div>
            
            <div>
                <strong>⚡ 電力・エネルギー</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-substation"></div>
                    <span>⚡ 変電所</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-power_pole"></div>
                    <span>🗼 電柱・鉄塔</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-generator"></div>
                    <span>🔋 発電機</span>
                </div>
            </div>
            
            <div>
                <strong>🚦 交通・その他</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-traffic_signals"></div>
                    <span>🚦 信号機</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-atm"></div>
                    <span>🏧 ATM</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-fuel_station"></div>
                    <span>⛽ ガソリンスタンド</span>
                </div>
            </div>
        </div>
        
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>🔍 詳細情報表示</strong><br>
            マーカーをクリックすると詳細な情報パネルが表示されます。OSMタグ、座標、外部リンクを含む包括的な情報を確認できます。<br>
            <strong>外部リンク:</strong> OpenStreetMap、Google Maps、Street View への直接アクセス
        </div>
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>📊 クラスタリング機能</strong><br>
            密集エリアでは自動的にグループ化されます。クラスタをクリックするとズームして詳細表示。<br>
            「📊 クラスタ情報」ボタンで統計情報を確認できます。<br>
            <span style="color: #e74c3c;">●</span> 監視カメラ主体
            <span style="color: #3498db;">●</span> 基地局主体
            <span style="color: #f39c12;">●</span> Wi-Fi主体
            <span style="color: #95a5a6;">●</span> 混在
        </div>
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>💾 データ出力機能</strong><br>
            取得したデータをGeoJSON/KML形式で出力可能。QGIS、Google Earth、ArcGIS等で利用できます。<br>
            <strong>GeoJSON:</strong> Web用、軽量、プログラミング向け｜<strong>KML:</strong> Google Earth用、視覚的
        </div>
    </div>

    <div style="margin-top: 30px; padding: 15px; text-align: center; border-top: 1px solid #000000; color: #6c757d;">
        🔗 GitHubリポジトリはこちら（<a href="https://github.com/ipusiron/osm-infra-viewer" target="_blank" style="color: #007bff; text-decoration: none;">ipusiron/osm-infra-viewer</a>）
        <br>
        <small style="font-size: 0.7rem; color: #aaa; margin-top: 5px; display: inline-block;">
            💡 上部の「⚙️ 開発者モード」ボタンでデバッグ機能が利用できます
        </small>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet MarkerCluster JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    
    <script>
        // 地図の初期化
        let map = L.map('map').setView([35.6762, 139.6503], 13); // 東京駅付近

        // OpenStreetMapタイル追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // マーカークラスターグループの作成
        let markersGroup = L.markerClusterGroup({
            // クラスタリングの設定
            maxClusterRadius: 50, // クラスタ化する最大距離（ピクセル）
            spiderfyOnMaxZoom: true, // 最大ズーム時にスパイダー表示
            showCoverageOnHover: false, // ホバー時の範囲表示を無効
            zoomToBoundsOnClick: true, // クリック時にズーム
            disableClusteringAtZoom: 18, // ズームレベル18以上でクラスタ無効
            
            // カスタムクラスタアイコンを作成
            iconCreateFunction: function(cluster) {
                const markers = cluster.getAllChildMarkers();
                let surveillanceCount = 0;
                let towerCount = 0;
                let wifiCount = 0;
                
                // 各マーカーのタイプをカウント
                markers.forEach(marker => {
                    const type = marker.options.infraType;
                    if (type === 'surveillance') surveillanceCount++;
                    else if (type === 'tower') towerCount++;
                    else if (type === 'wifi') wifiCount++;
                });
                
                const childCount = cluster.getChildCount();
                let clusterClass = 'marker-cluster-';
                let infraClass = 'cluster-mixed';
                
                // サイズクラスを決定
                if (childCount < 10) {
                    clusterClass += 'small';
                } else if (childCount < 50) {
                    clusterClass += 'medium';
                } else {
                    clusterClass += 'large';
                }
                
                // 主要なインフラタイプを決定
                const maxCount = Math.max(surveillanceCount, towerCount, wifiCount);
                if (surveillanceCount === maxCount && surveillanceCount > childCount * 0.6) {
                    infraClass = 'cluster-surveillance';
                } else if (towerCount === maxCount && towerCount > childCount * 0.6) {
                    infraClass = 'cluster-tower';
                } else if (wifiCount === maxCount && wifiCount > childCount * 0.6) {
                    infraClass = 'cluster-wifi';
                }
                
                return new L.DivIcon({
                    html: `<div><span>${childCount}</span></div>`,
                    className: `marker-cluster ${clusterClass} ${infraClass}`,
                    iconSize: new L.Point(40, 40)
                });
            }
        }).addTo(map);

        // ステータス表示
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Overpass APIクエリを構築
        function buildOverpassQuery(bounds) {
            const selectedTypes = [];
            
            // 各オブジェクトタイプのOSMタグ定義
            const objectTypes = {
                surveillance: ['man_made=surveillance', 'surveillance'],
                police: ['amenity=police', 'emergency=police'],
                emergency: ['emergency=phone', 'amenity=emergency_phone'],
                tower: ['man_made=communications_tower', 'man_made=tower', 'tower:type=communication'],
                wifi: ['internet_access=wlan', 'amenity=internet_cafe'],
                antenna: ['man_made=mast', 'man_made=antenna'],
                substation: ['power=substation', 'power=station'],
                power_pole: ['power=pole', 'power=tower', 'man_made=utility_pole'],
                generator: ['power=generator', 'man_made=generator'],
                traffic_signals: ['highway=traffic_signals'],
                speed_camera: ['highway=speed_camera', 'man_made=monitoring_station'],
                fuel_station: ['amenity=fuel'],
                atm: ['amenity=atm'],
                post_box: ['amenity=post_box'],
                waste_disposal: ['amenity=waste_disposal', 'man_made=waste_disposal']
            };

            // 選択されたオブジェクトタイプを収集
            Object.keys(objectTypes).forEach(type => {
                if (document.getElementById(type) && document.getElementById(type).checked) {
                    selectedTypes.push({type: type, tags: objectTypes[type]});
                }
            });

            if (selectedTypes.length === 0) {
                return null;
            }

            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query = '[out:json][timeout:25];\n(\n';
            
            selectedTypes.forEach(typeInfo => {
                typeInfo.tags.forEach(tag => {
                    if (tag.includes('=')) {
                        const [key, value] = tag.split('=');
                        query += `  node["${key}"="${value}"](${bbox});\n`;
                        query += `  way["${key}"="${value}"](${bbox});\n`;
                    } else {
                        // 属性のみ指定（値は任意）
                        query += `  node["${tag}"](${bbox});\n`;
                        query += `  way["${tag}"](${bbox});\n`;
                    }
                });
            });
            
            query += ');\nout center meta;';
            
            return query;
        }

        // マーカーの色とアイコンを決定
        function getMarkerInfo(element) {
            const tags = element.tags || {};
            
            // 監視・セキュリティ系
            if (tags.man_made === 'surveillance' || tags.surveillance) {
                return {
                    color: '#e74c3c',
                    icon: '📹',
                    type: 'CCTVカメラ',
                    infraType: 'surveillance'
                };
            } else if (tags.amenity === 'police' || tags.emergency === 'police') {
                return {
                    color: '#c0392b',
                    icon: '🚓',
                    type: '警察関連施設',
                    infraType: 'police'
                };
            } else if (tags.emergency === 'phone' || tags.amenity === 'emergency_phone') {
                return {
                    color: '#e67e22',
                    icon: '🆘',
                    type: '緊急電話',
                    infraType: 'emergency'
                };
            }
            
            // 通信・ネットワーク系
            else if (tags.man_made === 'communications_tower' || tags.man_made === 'tower' || tags['tower:type'] === 'communication') {
                return {
                    color: '#3498db',
                    icon: '📡',
                    type: '携帯基地局',
                    infraType: 'tower'
                };
            } else if (tags.internet_access === 'wlan' || tags.amenity === 'internet_cafe') {
                return {
                    color: '#f39c12',
                    icon: '📶',
                    type: 'Wi-Fiホットスポット',
                    infraType: 'wifi'
                };
            } else if (tags.man_made === 'mast' || tags.man_made === 'antenna') {
                return {
                    color: '#9b59b6',
                    icon: '📻',
                    type: 'アンテナ・マスト',
                    infraType: 'antenna'
                };
            }
            
            // 電力・エネルギー系
            else if (tags.power === 'substation' || tags.power === 'station') {
                return {
                    color: '#f1c40f',
                    icon: '⚡',
                    type: '変電所',
                    infraType: 'substation'
                };
            } else if (tags.power === 'pole' || tags.power === 'tower' || tags.man_made === 'utility_pole') {
                return {
                    color: '#d68910',
                    icon: '🗼',
                    type: '電柱・鉄塔',
                    infraType: 'power_pole'
                };
            } else if (tags.power === 'generator' || tags.man_made === 'generator') {
                return {
                    color: '#28b463',
                    icon: '🔋',
                    type: '発電機',
                    infraType: 'generator'
                };
            }
            
            // 交通・輸送系
            else if (tags.highway === 'traffic_signals') {
                return {
                    color: '#dc143c',
                    icon: '🚦',
                    type: '信号機',
                    infraType: 'traffic_signals'
                };
            } else if (tags.highway === 'speed_camera' || tags.man_made === 'monitoring_station') {
                return {
                    color: '#8b0000',
                    icon: '📸',
                    type: '交通監視カメラ',
                    infraType: 'speed_camera'
                };
            } else if (tags.amenity === 'fuel') {
                return {
                    color: '#ff6b6b',
                    icon: '⛽',
                    type: 'ガソリンスタンド',
                    infraType: 'fuel_station'
                };
            }
            
            // その他のインフラ
            else if (tags.amenity === 'atm') {
                return {
                    color: '#2ecc71',
                    icon: '🏧',
                    type: 'ATM',
                    infraType: 'atm'
                };
            } else if (tags.amenity === 'post_box') {
                return {
                    color: '#e74c3c',
                    icon: '📮',
                    type: '郵便ポスト',
                    infraType: 'post_box'
                };
            } else if (tags.amenity === 'waste_disposal' || tags.man_made === 'waste_disposal') {
                return {
                    color: '#7f8c8d',
                    icon: '🗑️',
                    type: 'ゴミ処理施設',
                    infraType: 'waste_disposal'
                };
            }
            
            return {
                color: '#95a5a6',
                icon: '📍',
                type: 'その他',
                infraType: 'other'
            };
        }

        // ポップアップの内容を生成（拡張版）
        function generatePopupContent(element, markerInfo) {
            const tags = element.tags || {};
            const lat = element.lat || (element.center ? element.center.lat : 0);
            const lon = element.lon || (element.center ? element.center.lon : 0);
            
            // ヘッダー部分
            let content = `<div class="popup-header">
                ${markerInfo.icon} ${markerInfo.type}
            </div>`;
            
            // 基本情報テーブル
            content += `<table class="popup-table">`;
            
            // 重要なタグを優先表示
            const priorityTags = [
                { key: 'name', label: '名称', category: '基本' },
                { key: 'operator', label: '運営者', category: '基本' },
                { key: 'surveillance:type', label: '監視タイプ', category: '監視' },
                { key: 'surveillance:zone', label: '監視範囲', category: '監視' },
                { key: 'camera:type', label: 'カメラ種別', category: '監視' },
                { key: 'camera:mount', label: '設置方法', category: '監視' },
                { key: 'height', label: '高さ', category: '物理' },
                { key: 'tower:type', label: 'タワー種別', category: '通信' },
                { key: 'communication:mobile_phone', label: '携帯電話対応', category: '通信' },
                { key: 'communication:radio', label: 'ラジオ対応', category: '通信' },
                { key: 'internet_access', label: 'インターネット', category: 'ネット' },
                { key: 'internet_access:fee', label: '利用料金', category: 'ネット' },
                { key: 'wifi', label: 'Wi-Fi', category: 'ネット' },
                { key: 'addr:street', label: '街路', category: '住所' },
                { key: 'addr:housenumber', label: '番地', category: '住所' },
                { key: 'addr:city', label: '市区町村', category: '住所' }
            ];
            
            // 優先タグを表示
            let displayedTags = new Set();
            priorityTags.forEach(tagInfo => {
                if (tags[tagInfo.key]) {
                    content += `<tr>
                        <th><span class="popup-tag-category">${tagInfo.category}</span>${tagInfo.label}</th>
                        <td>${escapeHtml(tags[tagInfo.key])}</td>
                    </tr>`;
                    displayedTags.add(tagInfo.key);
                }
            });
            
            // その他のタグを表示
            const otherTags = Object.keys(tags)
                .filter(key => !displayedTags.has(key) && !['man_made', 'amenity'].includes(key))
                .sort();
                
            if (otherTags.length > 0) {
                content += `<tr><th colspan="2" style="background: #e9ecef; text-align: center; font-weight: bold;">その他の属性</th></tr>`;
                otherTags.forEach(key => {
                    const value = tags[key];
                    if (value && value.length > 0) {
                        content += `<tr>
                            <th><span class="popup-tag-category">その他</span>${escapeHtml(key)}</th>
                            <td>${escapeHtml(value)}</td>
                        </tr>`;
                    }
                });
            }
            
            content += `</table>`;
            
            // 外部リンク
            content += `<div class="popup-external-links">
                <a href="https://www.openstreetmap.org/${element.type}/${element.id}" target="_blank">📍 OSMで見る</a>
                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">🗺️ Google Maps</a>
            `;
            
            // ストリートビューリンク（精度が高い場合のみ）
            if (lat && lon && Math.abs(lat) > 0.001 && Math.abs(lon) > 0.001) {
                content += `<a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}" target="_blank">👁️ Street View</a>`;
            }
            
            content += `</div>`;
            
            // メタデータ
            content += `<div class="popup-metadata">
                <div><strong>座標:</strong> <span class="popup-coordinates">${lat.toFixed(6)}, ${lon.toFixed(6)}</span></div>
                <div><strong>OSM ID:</strong> ${element.type}/${element.id}</div>
                <div><strong>データ取得:</strong> ${new Date().toLocaleDateString('ja-JP')} ${new Date().toLocaleTimeString('ja-JP')}</div>
                <div><strong>出典:</strong> © OpenStreetMap contributors</div>
            </div>`;
            
            return content;
        }

        // HTMLエスケープ関数
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // マーカーを地図に追加
        function addMarkersToMap(data) {
            console.log('🎯 マーカー追加開始');
            markersGroup.clearLayers();
            let count = 0;
            let skippedCount = 0;

            if (!data.elements || data.elements.length === 0) {
                console.log('⚠️ データが空です');
                showStatus('この範囲にはオブジェクトが見つかりませんでした', 'error');
                return;
            }

            data.elements.forEach((element, index) => {
                let lat, lon;
                
                if (element.lat && element.lon) {
                    lat = element.lat;
                    lon = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lon = element.center.lon;
                } else if (element.geometry && element.geometry.length > 0) {
                    lat = element.geometry[0].lat;
                    lon = element.geometry[0].lon;
                } else {
                    console.log(`⚠️ 座標なし [${index}]:`, element);
                    skippedCount++;
                    return; // 座標が取得できない場合はスキップ
                }

                const markerInfo = getMarkerInfo(element);
                console.log(`📍 マーカー作成 [${index}]: ${markerInfo.type} at ${lat}, ${lon}`);
                
                // カスタムマーカーを作成
                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: markerInfo.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    infraType: markerInfo.infraType // クラスタリング用のタイプ情報
                });

                const popupContent = generatePopupContent(element, markerInfo);
                
                // ポップアップオプションを設定
                const popupOptions = {
                    maxWidth: 450,
                    minWidth: 350,
                    autoPan: true,
                    closeButton: true,
                    autoClose: false,
                    className: 'custom-popup'
                };
                
                marker.bindPopup(popupContent, popupOptions);
                
                // マーカークリック時のイベント
                marker.on('click', function(e) {
                    console.log(`📍 マーカークリック: ${markerInfo.type} at ${lat}, ${lon}`);
                    console.log('OSMタグ:', element.tags);
                });
                
                markersGroup.addLayer(marker);
                count++;
            });

            console.log(`✅ マーカー追加完了: ${count}個表示, ${skippedCount}個スキップ`);
            
            if (count === 0) {
                showStatus(`データは取得できましたが、表示可能なオブジェクトがありませんでした（取得要素数: ${data.elements.length}）`, 'error');
            } else {
                showStatus(`${count}個のオブジェクトを表示しました`, 'success');
            }
        }

        // インフラストラクチャを検索
        async function searchInfrastructure() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            if (!query) {
                showStatus('検索するオブジェクトタイプを選択してください', 'error');
                return;
            }

            // デバッグ情報をコンソールに出力
            console.log('🔍 検索開始');
            console.log('検索範囲:', bounds);
            console.log('ズームレベル:', map.getZoom());
            console.log('Overpassクエリ:', query);

            showStatus('データを取得中...', 'loading');
            
            const searchBtn = document.querySelector('.search-btn');
            searchBtn.disabled = true;
            searchBtn.textContent = '検索中...';

            try {
                //複数のOverpass APIサーバーを試す
                const apiUrls = [
                    'https://overpass-api.de/api/interpreter',
                    'https://lz4.overpass-api.de/api/interpreter',
                    'https://z.overpass-api.de/api/interpreter'
                ];
                
                let response;
                let lastError;
                
                for (const apiUrl of apiUrls) {
                    try {
                        console.log(`🌐 API試行: ${apiUrl}`);
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: 'data=' + encodeURIComponent(query)
                        });
                        
                        if (response.ok) {
                            console.log(`✅ API成功: ${apiUrl}`);
                            break;
                        } else {
                            console.log(`❌ API失敗: ${apiUrl}, status: ${response.status}`);
                            lastError = new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.log(`❌ API接続エラー: ${apiUrl}`, error);
                        lastError = error;
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw lastError || new Error('すべてのAPIサーバーで失敗しました');
                }

                const data = await response.json();
                console.log('📊 取得データ:', data);
                console.log('要素数:', data.elements ? data.elements.length : 0);
                
                addMarkersToMap(data);
                
            } catch (error) {
                console.error('❌ エラー詳細:', error);
                showStatus('データの取得に失敗しました: ' + error.message, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '🔍 検索';
            }
        }

        // 地図移動時の処理
        map.on('moveend', function() {
            const zoom = map.getZoom();
            if (zoom < 10) {
                showStatus('詳細な検索には地図をより拡大してください（ズームレベル10以上推奨）', 'error');
            }
        });

        // ページ読み込み時のメッセージ
        window.addEventListener('load', function() {
            initializeDebugMode(); // デバッグモード初期化
            showStatus('お好みのインフラオブジェクトを選択し、地図を移動・ズームしてから検索ボタンをクリックしてください', 'success');
        });

        // テストマーカーを作成（簡単テスト用）
        function createTestMarker(lat, lon, tags, type) {
            const markerInfo = {
                color: '#27ae60',
                icon: '🧪',
                type: 'テストオブジェクト',
                infraType: 'test'
            };
            
            const marker = L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: markerInfo.color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
                infraType: 'test'
            });
            
            // テスト用の詳細なポップアップを作成
            const testElement = {
                id: `test_${Date.now()}`,
                type: 'node',
                lat: lat,
                lon: lon,
                tags: tags
            };
            
            const popupContent = generatePopupContent(testElement, markerInfo);
            const popupOptions = {
                maxWidth: 450,
                minWidth: 350,
                autoPan: true,
                closeButton: true,
                autoClose: false,
                className: 'custom-popup'
            };
            
            marker.bindPopup(popupContent, popupOptions);
            return marker;
        }

        // 簡単テストクエリ（デバッグ用）
        async function testSimpleQuery() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // 最もシンプルなクエリ（ATMを検索）
            const simpleQuery = `[out:json][timeout:25];
(
  node["amenity"="atm"](${bbox});
  node["amenity"="bank"](${bbox});
  node["shop"="convenience"](${bbox});
);
out center meta;`;

            console.log('🧪 簡単テスト開始');
            console.log('テストクエリ:', simpleQuery);
            
            showStatus('簡単テスト実行中（ATM・銀行・コンビニを検索）...', 'loading');
            
            try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(simpleQuery)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('🧪 テスト結果:', data);
                
                markersGroup.clearLayers();
                let count = 0;
                
                data.elements.forEach(element => {
                    if (element.lat && element.lon) {
                        const marker = createTestMarker(element.lat, element.lon, element.tags || {
                            name: element.tags?.name || 'テストオブジェクト',
                            amenity: element.tags?.amenity || element.tags?.shop || 'unknown',
                            operator: element.tags?.operator || '不明',
                            'addr:city': element.tags?.['addr:city'] || '',
                            'test:timestamp': new Date().toISOString()
                        }, element.tags?.amenity || element.tags?.shop || 'test');
                        
                        markersGroup.addLayer(marker);
                        count++;
                    }
                });
                
                showStatus(`テスト成功！${count}個のテストオブジェクトを表示`, 'success');
                
                // Overpass Turboリンクを生成
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(simpleQuery)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('🔗 Overpass Turboで確認:', turboUrl);
                
            } catch (error) {
                console.error('🧪 テストエラー:', error);
                showStatus('テスト失敗: ' + error.message, 'error');
            }
        }

        // エクスポート機能
        function showExportOptions() {
            const totalMarkers = markersGroup.getLayers().length;
            
            if (totalMarkers === 0) {
                showStatus('エクスポートするデータがありません。まず検索を実行してください。', 'error');
                return;
            }

            // カスタムダイアログを作成
            const dialogHtml = `
                <div id="export-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 1rem 0; color: #333; text-align: center;">💾 データエクスポート</h3>
                        <p style="margin: 0 0 1.5rem 0; color: #666; text-align: center;">現在${totalMarkers}個のオブジェクトがあります。<br>どの形式で出力しますか？</p>
                        
                        <div style="display: grid; gap: 0.8rem;">
                            <button onclick="exportToGeoJSON(); closeExportDialog();" style="padding: 0.8rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                📄 GeoJSON形式で出力<br>
                                <small style="opacity: 0.8;">Web用・軽量・プログラミング向け</small>
                            </button>
                            
                            <button onclick="exportToKML(); closeExportDialog();" style="padding: 0.8rem; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                🌍 KML形式で出力<br>
                                <small style="opacity: 0.8;">Google Earth用・視覚的</small>
                            </button>
                            
                            <button onclick="closeExportDialog();" style="padding: 0.8rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                ❌ キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ダイアログをページに追加
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
        }

        // 全選択・全解除機能
        function toggleAllObjects(enable) {
            const objectTypes = [
                'surveillance', 'police', 'emergency',
                'tower', 'wifi', 'antenna',
                'substation', 'power_pole', 'generator',
                'traffic_signals', 'speed_camera', 'fuel_station',
                'atm', 'post_box', 'waste_disposal'
            ];
            
            objectTypes.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    element.checked = enable;
                }
            });
            
            showStatus(enable ? '全てのオブジェクトを選択しました' : '全ての選択を解除しました', 'success');
        }

        // カテゴリ別選択機能
        function toggleCategory(category) {
            const categories = {
                security: ['surveillance', 'police', 'emergency'],
                communication: ['tower', 'wifi', 'antenna'],
                power: ['substation', 'power_pole', 'generator'],
                traffic: ['traffic_signals', 'speed_camera', 'fuel_station'],
                other: ['atm', 'post_box', 'waste_disposal']
            };
            
            const types = categories[category];
            if (!types) return;
            
            // 現在の選択状態を確認
            const currentStates = types.map(type => {
                const element = document.getElementById(type);
                return element ? element.checked : false;
            });
            
            // 全て選択されている場合は解除、そうでなければ全選択
            const allSelected = currentStates.every(state => state);
            const newState = !allSelected;
            
            types.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    element.checked = newState;
                }
            });
        }

        // エクスポートダイアログを閉じる
        function closeExportDialog() {
            const dialog = document.getElementById('export-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // GeoJSON形式でエクスポート
        function exportToGeoJSON() {
            console.log('📄 GeoJSONエクスポート開始');
            
            const features = [];
            
            markersGroup.eachLayer(function(layer) {
                if (layer.getLatLng && layer.options && layer.options.infraType) {
                    const latlng = layer.getLatLng();
                    const popupContent = layer.getPopup()?.getContent() || '';
                    
                    // ポップアップからタグ情報を抽出（簡易版）
                    const infraType = layer.options.infraType;
                    let name = 'Unknown';
                    let operator = '';
                    
                    // ポップアップ内容から名前と運営者を抽出
                    const nameMatch = popupContent.match(/<strong>name:<\/strong>\s*([^<]+)/);
                    const operatorMatch = popupContent.match(/<strong>operator:<\/strong>\s*([^<]+)/);
                    
                    if (nameMatch) name = nameMatch[1].trim();
                    if (operatorMatch) operator = operatorMatch[1].trim();

                    const feature = {
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: [latlng.lng, latlng.lat]
                        },
                        properties: {
                            name: name,
                            infraType: infraType,
                            operator: operator,
                            exportedAt: new Date().toISOString(),
                            source: "OpenStreetMap via OSM Infrastructure Viewer"
                        }
                    };
                    
                    features.push(feature);
                }
            });

            const geoJSON = {
                type: "FeatureCollection",
                metadata: {
                    title: "OSM Infrastructure Data",
                    description: "Infrastructure objects from OpenStreetMap",
                    generator: "OSM Infrastructure Viewer by IPUSIRON",
                    exportedAt: new Date().toISOString(),
                    count: features.length
                },
                features: features
            };

            const jsonString = JSON.stringify(geoJSON, null, 2);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `osm-infrastructure-${timestamp}.geojson`;
            
            downloadFile(jsonString, filename, 'application/geo+json');
            showStatus(`GeoJSON形式で${features.length}個のオブジェクトを出力しました`, 'success');
            
            console.log('✅ GeoJSONエクスポート完了:', features.length, 'features');
        }

        // KML形式でエクスポート
        function exportToKML() {
            console.log('📄 KMLエクスポート開始');
            
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>OSM Infrastructure Data</name>
    <description>Infrastructure objects from OpenStreetMap exported by OSM Infrastructure Viewer</description>
    
    <!-- Styles for different infrastructure types -->
    <Style id="surveillance">
      <IconStyle>
        <color>ff3c4ce7</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/surveillance.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="tower">
      <IconStyle>
        <color>ffdb5234</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/phone.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="wifi">
      <IconStyle>
        <color>ff12f39c</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/wifi.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <!-- Infrastructure Objects -->
`;

            let count = 0;
            markersGroup.eachLayer(function(layer) {
                if (layer.getLatLng && layer.options && layer.options.infraType) {
                    const latlng = layer.getLatLng();
                    const popupContent = layer.getPopup()?.getContent() || '';
                    const infraType = layer.options.infraType;
                    
                    // ポップアップからタグ情報を抽出
                    let name = `Infrastructure Object ${count + 1}`;
                    let operator = '';
                    let description = popupContent.replace(/<[^>]*>/g, ''); // HTMLタグを除去
                    
                    const nameMatch = popupContent.match(/<strong>name:<\/strong>\s*([^<]+)/);
                    const operatorMatch = popupContent.match(/<strong>operator:<\/strong>\s*([^<]+)/);
                    
                    if (nameMatch) name = nameMatch[1].trim();
                    if (operatorMatch) operator = operatorMatch[1].trim();

                    const infraTypeNames = {
                        surveillance: 'CCTV Camera',
                        tower: 'Communication Tower',
                        wifi: 'Wi-Fi Hotspot',
                        other: 'Other Infrastructure'
                    };

                    kmlContent += `    <Placemark>
      <name>${escapeXml(name)}</name>
      <description><![CDATA[
        <b>Type:</b> ${infraTypeNames[infraType] || infraType}<br/>
        <b>Operator:</b> ${escapeXml(operator)}<br/>
        <b>Coordinates:</b> ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}<br/>
        <b>Source:</b> OpenStreetMap<br/>
        <hr/>
        ${description}
      ]]></description>
      <styleUrl>#${infraType}</styleUrl>
      <Point>
        <coordinates>${latlng.lng},${latlng.lat},0</coordinates>
      </Point>
    </Placemark>
`;
                    count++;
                }
            });

            kmlContent += `  </Document>
</kml>`;

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `osm-infrastructure-${timestamp}.kml`;
            
            downloadFile(kmlContent, filename, 'application/vnd.google-earth.kml+xml');
            showStatus(`KML形式で${count}個のオブジェクトを出力しました`, 'success');
            
            console.log('✅ KMLエクスポート完了:', count, 'placemarks');
        }

        // XML用エスケープ
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // ファイルダウンロード
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`📁 ファイルダウンロード: ${filename} (${(blob.size / 1024).toFixed(1)} KB)`);
        }

        // クラスタ情報表示（開発者モード）
        function showClusterInfo() {
            const totalMarkers = markersGroup.getLayers().length;
            const clusters = [];
            
            // 表示中のクラスタを収集
            markersGroup.eachLayer(function(layer) {
                if (layer instanceof L.MarkerCluster) {
                    const markers = layer.getAllChildMarkers();
                    let infraCounts = {};
                    
                    markers.forEach(marker => {
                        const type = marker.options.infraType || 'other';
                        infraCounts[type] = (infraCounts[type] || 0) + 1;
                    });
                    
                    clusters.push({
                        count: markers.length,
                        infraCounts: infraCounts,
                        bounds: layer.getBounds()
                    });
                }
            });
            
            console.log('📊 クラスタ分析結果');
            console.log('総マーカー数:', totalMarkers);
            console.log('クラスタ数:', clusters.length);
            console.log('平均クラスタサイズ:', clusters.length > 0 ? (totalMarkers / clusters.length).toFixed(1) : 0);
            console.log('クラスタ詳細:', clusters);
            
            // 統計情報を計算
            let infraTypeCounts = {};
            markersGroup.eachLayer(function(layer) {
                if (layer.options && layer.options.infraType) {
                    const type = layer.options.infraType;
                    infraTypeCounts[type] = (infraTypeCounts[type] || 0) + 1;
                }
            });
            
            const clusteringRatio = clusters.length > 0 ? ((totalMarkers - clusters.length) / totalMarkers * 100).toFixed(1) : 0;
            
            showStatus(`クラスタ分析完了 - クラスタリング率: ${clusteringRatio}%`, 'success');
            
            // インフラタイプ別の統計を表示
            const infraStatsText = Object.entries(infraTypeCounts)
                .map(([type, count]) => `${type}: ${count}`)
                .join('\n');
            
            alert(`📊 クラスタ分析結果\n\n総マーカー数: ${totalMarkers}\n━━━━━━━━━━━━━━━━━━━━\n${infraStatsText}\n━━━━━━━━━━━━━━━━━━━━\nアクティブクラスタ数: ${clusters.length}\nクラスタリング効率: ${clusteringRatio}%\n\n詳細はコンソールを確認してください。`);
        }

        // テスト地点にジャンプ
        function jumpToTestLocation() {
            // 監視カメラや通信設備が多い地域を選択
            const testLocations = [
                { name: 'ロンドン市内（監視カメラ多数）', lat: 51.5074, lng: -0.1278, zoom: 16 },
                { name: 'ベルリン中央駅', lat: 52.5251, lng: 13.3693, zoom: 17 },
                { name: 'パリ シャンゼリゼ', lat: 48.8738, lng: 2.2950, zoom: 17 },
                { name: 'ニューヨーク タイムズスクエア', lat: 40.7580, lng: -73.9855, zoom: 17 },
                { name: '渋谷スクランブル交差点', lat: 35.6595, lng: 139.7006, zoom: 18 },
                { name: '新宿駅東口', lat: 35.6896, lng: 139.7006, zoom: 17 }
            ];
            
            const location = testLocations[Math.floor(Math.random() * testLocations.length)];
            map.setView([location.lat, location.lng], location.zoom);
            showStatus(`${location.name}にジャンプしました`, 'success');
            console.log(`📍 テスト地点: ${location.name} (${location.lat}, ${location.lng})`);
        }

        // デバッグ情報表示
        function showDebugInfo() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            const totalMarkers = markersGroup.getLayers().length;
            
            // 選択されたオブジェクト一覧
            const objectTypes = ['surveillance', 'police', 'emergency', 'tower', 'wifi', 'antenna', 'substation', 'power_pole', 'generator', 'traffic_signals', 'speed_camera', 'fuel_station', 'atm', 'post_box', 'waste_disposal'];
            const selectedObjects = {};
            objectTypes.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    selectedObjects[type] = element.checked;
                }
            });
            
            console.log('=== 🔧 デバッグ情報 ===');
            console.log('現在位置:', map.getCenter());
            console.log('ズームレベル:', map.getZoom());
            console.log('検索範囲:', bounds);
            console.log('範囲サイズ (緯度):', bounds.getNorth() - bounds.getSouth());
            console.log('範囲サイズ (経度):', bounds.getEast() - bounds.getWest());
            console.log('選択オブジェクト:', selectedObjects);
            console.log('選択数:', Object.values(selectedObjects).filter(v => v).length);
            console.log('総マーカー数:', totalMarkers);
            console.log('エクスポート可能:', totalMarkers > 0 ? 'Yes' : 'No');
            console.log('Overpassクエリ:', query);
            console.log('ブラウザ:', navigator.userAgent);
            console.log('HTTPS:', location.protocol === 'https:');
            
            // Overpass Turboリンクを生成
            if (query) {
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('🔗 Overpass Turboで確認:', turboUrl);
            }
            console.log('===================');
            
            const selectedCount = Object.values(selectedObjects).filter(v => v).length;
            const turboLink = query ? `\n\n🔗 Overpass Turboでテスト:\nhttps://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}` : '';
            
            alert(`デバッグ情報をコンソールに出力しました。\n\n現在地: ${map.getCenter().lat.toFixed(4)}, ${map.getCenter().lng.toFixed(4)}\nズーム: ${map.getZoom()}\n選択オブジェクト: ${selectedCount}種類\nマーカー数: ${totalMarkers}\nエクスポート: ${totalMarkers > 0 ? '可能' : '不可'}\n\nF12キーでコンソールを確認してください。${turboLink}`);
        }

        // デバッグモードの状態管理
        let isDebugModeActive = false;

        // デバッグモード切り替え
        function toggleDebugMode() {
            isDebugModeActive = !isDebugModeActive;
            const debugControls = document.getElementById('debug-controls');
            const toggleButton = event.target;
            
            if (isDebugModeActive) {
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">🔧 デバッグ情報</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">📍 テスト地点</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">🧪 簡単テスト</button>
                `;
                toggleButton.textContent = '⚙️ 開発者モード ON';
                toggleButton.style.background = '#28a745';
                console.log('🔧 開発者モードが有効になりました');
                showStatus('開発者モードが有効です - デバッグ機能が利用できます', 'success');
            } else {
                debugControls.style.display = 'none';
                debugControls.innerHTML = '';
                toggleButton.textContent = '⚙️ 開発者モード';
                toggleButton.style.background = '#6c757d';
                console.log('🔒 開発者モードが無効になりました');
                showStatus('開発者モードが無効になりました', 'success');
            }
        }

        // デバッグモードの確認と初期化
        function initializeDebugMode() {
            // URLパラメータでも対応（オプション）
            const urlParams = new URLSearchParams(window.location.search);
            const isDebugMode = urlParams.get('debug') === 'true';
            
            if (isDebugMode) {
                // URLパラメータ経由の場合は自動で開発者モードを有効化
                // toggleDebugMode関数を呼び出さずに直接設定
                isDebugModeActive = true;
                const debugControls = document.getElementById('debug-controls');
                const toggleButton = document.querySelector('.dev-mode-btn');
                
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">🔧 デバッグ情報</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">📍 テスト地点</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">🧪 簡単テスト</button>
                `;
                toggleButton.textContent = '⚙️ 開発者モード ON';
                toggleButton.style.background = '#28a745';
                console.log('🔧 開発者モードが有効になりました（URL経由）');
                showStatus('開発者モードが有効です（URL経由）', 'success');
            }
        }

        // 位置情報取得（オプション）
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('このブラウザは位置情報をサポートしていません');
                return;
            }

            // 位置情報取得のオプション
            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000 // 10分間キャッシュを使用
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 15);
                    showStatus('現在地を中心に地図を表示しました', 'success');
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の使用が拒否されました。手動で地図を移動してください。';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が利用できません。';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました。';
                            break;
                        default:
                            errorMessage = '位置情報の取得でエラーが発生しました。';
                            break;
                    }
                    console.log('位置情報エラー:', errorMessage);
                    // エラーは表示せず、デフォルト位置（東京）で開始
                },
                options
            );
        }

        // 位置情報取得を実行
        initializeLocation();
    </script>
</body>
</html>
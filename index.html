<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMインフラ可視化ツール（OSM Infrastructure Viewer）</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .map-container {
            margin: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        #map {
            height: 600px;
            width: 100%;
        }

        .status {
            margin: 1rem;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .legend {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .marker-surveillance { background: #e74c3c; }
        .marker-tower { background: #3498db; }
        .marker-wifi { background: #f39c12; }

        @media (max-width: 768px) {
            .controls {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            .checkbox-group {
                gap: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
            }
            
            #map {
                height: 500px;
            }
            
            .legend {
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🗺️ OSMインフラ可視化ツール（OSM Infrastructure Viewer）</h1>
        <p>OpenStreetMapのインフラ系オブジェクト（CCTV、基地局、Wi-Fi）を可視化するツール</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>表示オブジェクト:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="surveillance" value="surveillance" checked>
                    <label for="surveillance">CCTVカメラ</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tower" value="tower" checked>
                    <label for="tower">携帯基地局</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="wifi" value="wifi" checked>
                    <label for="wifi">Wi-Fiホットスポット</label>
                </div>
            </div>
        </div>
        <button class="search-btn" onclick="searchInfrastructure()">🔍 検索</button>
        <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">🔧 デバッグ情報</button>
        <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">📍 テスト地点</button>
        <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">🧪 簡単テスト</button>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="legend">
        <h3>凡例</h3>
        <div class="legend-item">
            <div class="legend-marker marker-surveillance"></div>
            <span>CCTVカメラ (man_made=surveillance)</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker marker-tower"></div>
            <span>携帯基地局 (man_made=communications_tower)</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker marker-wifi"></div>
            <span>Wi-Fiホットスポット (internet_access=wlan)</span>
        </div>
    </div>

    <div style="margin-top: 30px; padding: 15px; text-align: center; border-top: 1px solid #000000; color: #6c757d;">
        🔗 GitHubリポジトリはこちら（<a href="https://github.com/ipusiron/osm-infra-viewer" target="_blank" style="color: #007bff; text-decoration: none;">ipusiron/osm-infra-viewer</a>）
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // 地図の初期化
        let map = L.map('map').setView([35.6762, 139.6503], 13); // 東京駅付近

        // OpenStreetMapタイル追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // マーカーグループ
        let markersGroup = L.layerGroup().addTo(map);

        // ステータス表示
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Overpass APIクエリを構築
        function buildOverpassQuery(bounds) {
            const selectedTypes = [];
            
            if (document.getElementById('surveillance').checked) {
                selectedTypes.push('surveillance');
            }
            if (document.getElementById('tower').checked) {
                selectedTypes.push('tower');
            }
            if (document.getElementById('wifi').checked) {
                selectedTypes.push('wifi');
            }

            if (selectedTypes.length === 0) {
                return null;
            }

            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query = '[out:json][timeout:25];\n(\n';
            
            selectedTypes.forEach(type => {
                if (type === 'surveillance') {
                    // 監視カメラ - より広範囲なクエリ
                    query += `  node["man_made"="surveillance"](${bbox});\n`;
                    query += `  way["man_made"="surveillance"](${bbox});\n`;
                    query += `  node["surveillance"](${bbox});\n`;
                } else if (type === 'tower') {
                    // 通信塔・基地局
                    query += `  node["man_made"="communications_tower"](${bbox});\n`;
                    query += `  node["man_made"="tower"]["tower:type"="communication"](${bbox});\n`;
                    query += `  node["man_made"="mast"](${bbox});\n`;
                } else if (type === 'wifi') {
                    // Wi-Fi関連
                    query += `  node["internet_access"="wlan"](${bbox});\n`;
                    query += `  node["amenity"="internet_cafe"](${bbox});\n`;
                    query += `  node["amenity"="cafe"]["internet_access"="wlan"](${bbox});\n`;
                }
            });
            
            query += ');\nout center meta;';
            
            return query;
        }

        // マーカーの色とアイコンを決定
        function getMarkerInfo(element) {
            const tags = element.tags || {};
            
            if (tags.man_made === 'surveillance') {
                return {
                    color: '#e74c3c',
                    icon: '📹',
                    type: 'CCTVカメラ'
                };
            } else if (tags.man_made === 'communications_tower') {
                return {
                    color: '#3498db',
                    icon: '📡',
                    type: '携帯基地局'
                };
            } else if (tags.internet_access === 'wlan') {
                return {
                    color: '#f39c12',
                    icon: '📶',
                    type: 'Wi-Fiホットスポット'
                };
            }
            
            return {
                color: '#95a5a6',
                icon: '📍',
                type: 'その他'
            };
        }

        // ポップアップの内容を生成
        function generatePopupContent(element, markerInfo) {
            const tags = element.tags || {};
            let content = `<div style="min-width: 200px;">`;
            content += `<h4 style="margin: 0 0 10px 0; color: ${markerInfo.color};">${markerInfo.icon} ${markerInfo.type}</h4>`;
            
            // 重要な属性を優先表示
            const importantKeys = ['name', 'operator', 'surveillance:type', 'tower:type', 'height', 'description'];
            const displayedKeys = new Set();
            
            importantKeys.forEach(key => {
                if (tags[key]) {
                    content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
                    displayedKeys.add(key);
                }
            });
            
            // その他の属性
            const otherTags = Object.keys(tags).filter(key => !displayedKeys.has(key));
            if (otherTags.length > 0) {
                content += `<hr style="margin: 10px 0;">`;
                otherTags.forEach(key => {
                    if (key !== 'man_made' && key !== 'internet_access') {
                        content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
                    }
                });
            }
            
            content += `<hr style="margin: 10px 0;">`;
            content += `<div style="font-size: 0.8em; color: #666;">`;
            content += `<div>ID: ${element.id}</div>`;
            if (element.lat && element.lon) {
                content += `<div>位置: ${element.lat.toFixed(6)}, ${element.lon.toFixed(6)}</div>`;
            }
            content += `</div></div>`;
            
            return content;
        }

        // マーカーを地図に追加
        function addMarkersToMap(data) {
            console.log('🎯 マーカー追加開始');
            markersGroup.clearLayers();
            let count = 0;
            let skippedCount = 0;

            if (!data.elements || data.elements.length === 0) {
                console.log('⚠️ データが空です');
                showStatus('この範囲にはオブジェクトが見つかりませんでした', 'error');
                return;
            }

            data.elements.forEach((element, index) => {
                let lat, lon;
                
                if (element.lat && element.lon) {
                    lat = element.lat;
                    lon = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lon = element.center.lon;
                } else if (element.geometry && element.geometry.length > 0) {
                    lat = element.geometry[0].lat;
                    lon = element.geometry[0].lon;
                } else {
                    console.log(`⚠️ 座標なし [${index}]:`, element);
                    skippedCount++;
                    return; // 座標が取得できない場合はスキップ
                }

                const markerInfo = getMarkerInfo(element);
                console.log(`📍 マーカー作成 [${index}]: ${markerInfo.type} at ${lat}, ${lon}`);
                
                // カスタムマーカーを作成
                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: markerInfo.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                const popupContent = generatePopupContent(element, markerInfo);
                marker.bindPopup(popupContent);
                
                markersGroup.addLayer(marker);
                count++;
            });

            console.log(`✅ マーカー追加完了: ${count}個表示, ${skippedCount}個スキップ`);
            
            if (count === 0) {
                showStatus(`データは取得できましたが、表示可能なオブジェクトがありませんでした（取得要素数: ${data.elements.length}）`, 'error');
            } else {
                showStatus(`${count}個のオブジェクトを表示しました`, 'success');
            }
        }

        // インフラストラクチャを検索
        async function searchInfrastructure() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            if (!query) {
                showStatus('検索するオブジェクトタイプを選択してください', 'error');
                return;
            }

            // デバッグ情報をコンソールに出力
            console.log('🔍 検索開始');
            console.log('検索範囲:', bounds);
            console.log('ズームレベル:', map.getZoom());
            console.log('Overpassクエリ:', query);

            showStatus('データを取得中...', 'loading');
            
            const searchBtn = document.querySelector('.search-btn');
            searchBtn.disabled = true;
            searchBtn.textContent = '検索中...';

            try {
                //複数のOverpass APIサーバーを試す
                const apiUrls = [
                    'https://overpass-api.de/api/interpreter',
                    'https://lz4.overpass-api.de/api/interpreter',
                    'https://z.overpass-api.de/api/interpreter'
                ];
                
                let response;
                let lastError;
                
                for (const apiUrl of apiUrls) {
                    try {
                        console.log(`🌐 API試行: ${apiUrl}`);
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: 'data=' + encodeURIComponent(query)
                        });
                        
                        if (response.ok) {
                            console.log(`✅ API成功: ${apiUrl}`);
                            break;
                        } else {
                            console.log(`❌ API失敗: ${apiUrl}, status: ${response.status}`);
                            lastError = new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.log(`❌ API接続エラー: ${apiUrl}`, error);
                        lastError = error;
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw lastError || new Error('すべてのAPIサーバーで失敗しました');
                }

                const data = await response.json();
                console.log('📊 取得データ:', data);
                console.log('要素数:', data.elements ? data.elements.length : 0);
                
                addMarkersToMap(data);
                
            } catch (error) {
                console.error('❌ エラー詳細:', error);
                showStatus('データの取得に失敗しました: ' + error.message, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '🔍 検索';
            }
        }

        // 地図移動時の処理
        map.on('moveend', function() {
            const zoom = map.getZoom();
            if (zoom < 10) {
                showStatus('詳細な検索には地図をより拡大してください（ズームレベル10以上推奨）', 'error');
            }
        });

        // ページ読み込み時のメッセージ
        window.addEventListener('load', function() {
            showStatus('地図を移動・ズームしてから検索ボタンをクリックしてください', 'success');
        });

        // 簡単テストクエリ（デバッグ用）
        async function testSimpleQuery() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // 最もシンプルなクエリ（ATMを検索）
            const simpleQuery = `[out:json][timeout:25];
(
  node["amenity"="atm"](${bbox});
  node["amenity"="bank"](${bbox});
  node["shop"="convenience"](${bbox});
);
out center meta;`;

            console.log('🧪 簡単テスト開始');
            console.log('テストクエリ:', simpleQuery);
            
            showStatus('簡単テスト実行中（ATM・銀行・コンビニを検索）...', 'loading');
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(simpleQuery)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('🧪 テスト結果:', data);
                
                markersGroup.clearLayers();
                let count = 0;
                
                data.elements.forEach(element => {
                    if (element.lat && element.lon) {
                        const marker = L.circleMarker([element.lat, element.lon], {
                            radius: 6,
                            fillColor: '#27ae60',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                        
                        const tags = element.tags || {};
                        const name = tags.name || tags.amenity || tags.shop || 'Unknown';
                        marker.bindPopup(`<strong>テスト結果</strong><br>種類: ${name}<br>ID: ${element.id}`);
                        markersGroup.addLayer(marker);
                        count++;
                    }
                });
                
                showStatus(`テスト成功！${count}個のテストオブジェクトを表示`, 'success');
                
                // Overpass Turboリンクを生成
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(simpleQuery)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('🔗 Overpass Turboで確認:', turboUrl);
                
            } catch (error) {
                console.error('🧪 テストエラー:', error);
                showStatus('テスト失敗: ' + error.message, 'error');
            }
        }

        // テスト地点にジャンプ
        function jumpToTestLocation() {
            // 監視カメラや通信設備が多い地域を選択
            const testLocations = [
                { name: 'ロンドン市内（監視カメラ多数）', lat: 51.5074, lng: -0.1278, zoom: 16 },
                { name: 'ベルリン中央駅', lat: 52.5251, lng: 13.3693, zoom: 17 },
                { name: 'パリ シャンゼリゼ', lat: 48.8738, lng: 2.2950, zoom: 17 },
                { name: 'ニューヨーク タイムズスクエア', lat: 40.7580, lng: -73.9855, zoom: 17 },
                { name: '渋谷スクランブル交差点', lat: 35.6595, lng: 139.7006, zoom: 18 },
                { name: '新宿駅東口', lat: 35.6896, lng: 139.7006, zoom: 17 }
            ];
            
            const location = testLocations[Math.floor(Math.random() * testLocations.length)];
            map.setView([location.lat, location.lng], location.zoom);
            showStatus(`${location.name}にジャンプしました`, 'success');
            console.log(`📍 テスト地点: ${location.name} (${location.lat}, ${location.lng})`);
        }

        // デバッグ情報表示
        function showDebugInfo() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            console.log('=== 🔧 デバッグ情報 ===');
            console.log('現在位置:', map.getCenter());
            console.log('ズームレベル:', map.getZoom());
            console.log('検索範囲:', bounds);
            console.log('範囲サイズ (緯度):', bounds.getNorth() - bounds.getSouth());
            console.log('範囲サイズ (経度):', bounds.getEast() - bounds.getWest());
            console.log('選択オブジェクト:', {
                surveillance: document.getElementById('surveillance').checked,
                tower: document.getElementById('tower').checked,
                wifi: document.getElementById('wifi').checked
            });
            console.log('Overpassクエリ:', query);
            console.log('現在のマーカー数:', markersGroup.getLayers().length);
            console.log('ブラウザ:', navigator.userAgent);
            console.log('HTTPS:', location.protocol === 'https:');
            
            // Overpass Turboリンクを生成
            if (query) {
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('🔗 Overpass Turboで確認:', turboUrl);
            }
            console.log('===================');
            
            const turboLink = query ? `\n\n🔗 Overpass Turboでテスト:\nhttps://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}` : '';
            
            alert(`デバッグ情報をコンソールに出力しました。\n\n現在地: ${map.getCenter().lat.toFixed(4)}, ${map.getCenter().lng.toFixed(4)}\nズーム: ${map.getZoom()}\nマーカー数: ${markersGroup.getLayers().length}\n\nF12キーでコンソールを確認してください。${turboLink}`);
        }

        // 位置情報取得（オプション）
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('このブラウザは位置情報をサポートしていません');
                return;
            }

            // 位置情報取得のオプション
            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000 // 10分間キャッシュを使用
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 15);
                    showStatus('現在地を中心に地図を表示しました', 'success');
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の使用が拒否されました。手動で地図を移動してください。';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が利用できません。';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました。';
                            break;
                        default:
                            errorMessage = '位置情報の取得でエラーが発生しました。';
                            break;
                    }
                    console.log('位置情報エラー:', errorMessage);
                    // エラーは表示せず、デフォルト位置（東京）で開始
                },
                options
            );
        }

        // 位置情報取得を実行
        initializeLocation();
    </script>
</body>
</html>
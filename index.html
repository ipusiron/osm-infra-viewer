<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSM Infrastructure Viewer</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .header p {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .controls {
        background: white;
        padding: 1rem;
        margin: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .control-group label {
        font-weight: 500;
        color: #333;
      }

      .checkbox-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .checkbox-item input[type='checkbox'] {
        width: 16px;
        height: 16px;
        accent-color: #667eea;
      }

      .checkbox-item label {
        font-size: 0.9rem;
        color: #555;
        cursor: pointer;
      }

      .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .map-container {
        margin: 1rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }

      #map {
        height: 600px;
        width: 100%;
      }

      .status {
        margin: 1rem;
        padding: 0.8rem;
        border-radius: 6px;
        font-weight: 500;
        display: none;
      }

      .status.loading {
        background: #e3f2fd;
        color: #1976d2;
        border-left: 4px solid #2196f3;
        display: block;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
        display: block;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
        display: block;
      }

      .legend {
        background: white;
        padding: 1rem;
        margin: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .legend h3 {
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 1.1rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.3rem;
      }

      .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .marker-surveillance {
        background: #e74c3c;
      }
      .marker-tower {
        background: #3498db;
      }
      .marker-wifi {
        background: #f39c12;
      }

      @media (max-width: 768px) {
        .controls {
          margin: 0.5rem;
          padding: 0.8rem;
        }

        .checkbox-group {
          gap: 0.5rem;
        }

        .map-container {
          margin: 0.5rem;
        }

        #map {
          height: 500px;
        }

        .legend {
          margin: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>🗺️ OSM Infrastructure Viewer</h1>
      <p>
        OpenStreetMapのインフラ系オブジェクト（CCTV、基地局、Wi-Fi）を可視化するツール
      </p>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>表示オブジェクト:</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input
              type="checkbox"
              id="surveillance"
              value="surveillance"
              checked
            />
            <label for="surveillance">CCTVカメラ</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="tower" value="tower" checked />
            <label for="tower">携帯基地局</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="wifi" value="wifi" checked />
            <label for="wifi">Wi-Fiホットスポット</label>
          </div>
        </div>
      </div>
      <button class="search-btn" onclick="searchInfrastructure()">
        🔍 検索
      </button>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
      <div id="map"></div>
    </div>

    <div class="legend">
      <h3>凡例</h3>
      <div class="legend-item">
        <div class="legend-marker marker-surveillance"></div>
        <span>CCTVカメラ (man_made=surveillance)</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-tower"></div>
        <span>携帯基地局 (man_made=communications_tower)</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-wifi"></div>
        <span>Wi-Fiホットスポット (internet_access=wlan)</span>
      </div>
    </div>

    <div
      style="
        margin-top: 30px;
        padding: 15px;
        text-align: center;
        border-top: 1px solid #000000;
        color: #6c757d;
      "
    >
      🔗 GitHubリポジトリはこちら（<a
        href="https://github.com/ipusiron/caesar-cipher-wheel"
        target="_blank"
        style="color: #007bff; text-decoration: none"
        >ipusiron/caesar-cipher-wheel</a
      >）
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
      // 地図の初期化
      let map = L.map('map').setView([35.6762, 139.6503], 13); // 東京駅付近

      // OpenStreetMapタイル追加
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // マーカーグループ
      let markersGroup = L.layerGroup().addTo(map);

      // ステータス表示
      function showStatus(message, type = 'loading') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type}`;

        if (type !== 'loading') {
          setTimeout(() => {
            status.style.display = 'none';
          }, 5000);
        }
      }

      // Overpass APIクエリを構築
      function buildOverpassQuery(bounds) {
        const selectedTypes = [];

        if (document.getElementById('surveillance').checked) {
          selectedTypes.push('man_made=surveillance');
        }
        if (document.getElementById('tower').checked) {
          selectedTypes.push('man_made=communications_tower');
        }
        if (document.getElementById('wifi').checked) {
          selectedTypes.push('internet_access=wlan');
        }

        if (selectedTypes.length === 0) {
          return null;
        }

        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;

        let query = '[out:json][timeout:25];\n(\n';

        selectedTypes.forEach((type) => {
          if (type === 'internet_access=wlan') {
            query += `  node["${type}"](${bbox});\n`;
            query += `  way["${type}"](${bbox});\n`;
            query += `  relation["${type}"](${bbox});\n`;
          } else {
            query += `  node["${type}"](${bbox});\n`;
            query += `  way["${type}"](${bbox});\n`;
            query += `  relation["${type}"](${bbox});\n`;
          }
        });

        query += ');\nout geom;';

        return query;
      }

      // マーカーの色とアイコンを決定
      function getMarkerInfo(element) {
        const tags = element.tags || {};

        if (tags.man_made === 'surveillance') {
          return {
            color: '#e74c3c',
            icon: '📹',
            type: 'CCTVカメラ',
          };
        } else if (tags.man_made === 'communications_tower') {
          return {
            color: '#3498db',
            icon: '📡',
            type: '携帯基地局',
          };
        } else if (tags.internet_access === 'wlan') {
          return {
            color: '#f39c12',
            icon: '📶',
            type: 'Wi-Fiホットスポット',
          };
        }

        return {
          color: '#95a5a6',
          icon: '📍',
          type: 'その他',
        };
      }

      // ポップアップの内容を生成
      function generatePopupContent(element, markerInfo) {
        const tags = element.tags || {};
        let content = `<div style="min-width: 200px;">`;
        content += `<h4 style="margin: 0 0 10px 0; color: ${markerInfo.color};">${markerInfo.icon} ${markerInfo.type}</h4>`;

        // 重要な属性を優先表示
        const importantKeys = [
          'name',
          'operator',
          'surveillance:type',
          'tower:type',
          'height',
          'description',
        ];
        const displayedKeys = new Set();

        importantKeys.forEach((key) => {
          if (tags[key]) {
            content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
            displayedKeys.add(key);
          }
        });

        // その他の属性
        const otherTags = Object.keys(tags).filter(
          (key) => !displayedKeys.has(key)
        );
        if (otherTags.length > 0) {
          content += `<hr style="margin: 10px 0;">`;
          otherTags.forEach((key) => {
            if (key !== 'man_made' && key !== 'internet_access') {
              content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
            }
          });
        }

        content += `<hr style="margin: 10px 0;">`;
        content += `<div style="font-size: 0.8em; color: #666;">`;
        content += `<div>ID: ${element.id}</div>`;
        if (element.lat && element.lon) {
          content += `<div>位置: ${element.lat.toFixed(
            6
          )}, ${element.lon.toFixed(6)}</div>`;
        }
        content += `</div></div>`;

        return content;
      }

      // マーカーを地図に追加
      function addMarkersToMap(data) {
        markersGroup.clearLayers();
        let count = 0;

        data.elements.forEach((element) => {
          let lat, lon;

          if (element.lat && element.lon) {
            lat = element.lat;
            lon = element.lon;
          } else if (element.center) {
            lat = element.center.lat;
            lon = element.center.lon;
          } else if (element.geometry && element.geometry.length > 0) {
            lat = element.geometry[0].lat;
            lon = element.geometry[0].lon;
          } else {
            return; // 座標が取得できない場合はスキップ
          }

          const markerInfo = getMarkerInfo(element);

          // カスタムマーカーを作成
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: markerInfo.color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
          });

          const popupContent = generatePopupContent(element, markerInfo);
          marker.bindPopup(popupContent);

          markersGroup.addLayer(marker);
          count++;
        });

        showStatus(`${count}個のオブジェクトを表示しました`, 'success');
      }

      // インフラストラクチャを検索
      async function searchInfrastructure() {
        const bounds = map.getBounds();
        const query = buildOverpassQuery(bounds);

        if (!query) {
          showStatus('検索するオブジェクトタイプを選択してください', 'error');
          return;
        }

        showStatus('データを取得中...', 'loading');

        const searchBtn = document.querySelector('.search-btn');
        searchBtn.disabled = true;
        searchBtn.textContent = '検索中...';

        try {
          const response = await fetch(
            'https://overpass-api.de/api/interpreter',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: 'data=' + encodeURIComponent(query),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          addMarkersToMap(data);
        } catch (error) {
          console.error('Error fetching data:', error);
          showStatus('データの取得に失敗しました: ' + error.message, 'error');
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = '🔍 検索';
        }
      }

      // 地図移動時の処理
      map.on('moveend', function () {
        const zoom = map.getZoom();
        if (zoom < 10) {
          showStatus(
            '詳細な検索には地図をより拡大してください（ズームレベル10以上推奨）',
            'error'
          );
        }
      });

      // ページ読み込み時のメッセージ
      window.addEventListener('load', function () {
        showStatus(
          '地図を移動・ズームしてから検索ボタンをクリックしてください',
          'success'
        );
      });

      // 位置情報取得（オプション）
      function initializeLocation() {
        if (!navigator.geolocation) {
          console.log('このブラウザは位置情報をサポートしていません');
          return;
        }

        // 位置情報取得のオプション
        const options = {
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 600000, // 10分間キャッシュを使用
        };

        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            map.setView([lat, lon], 15);
            showStatus('現在地を中心に地図を表示しました', 'success');
          },
          function (error) {
            let errorMessage = '';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage =
                  '位置情報の使用が拒否されました。手動で地図を移動してください。';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = '位置情報が利用できません。';
                break;
              case error.TIMEOUT:
                errorMessage = '位置情報の取得がタイムアウトしました。';
                break;
              default:
                errorMessage = '位置情報の取得でエラーが発生しました。';
                break;
            }
            console.log('位置情報エラー:', errorMessage);
            // エラーは表示せず、デフォルト位置（東京）で開始
          },
          options
        );
      }

      // 位置情報取得を実行
      initializeLocation();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMã‚¤ãƒ³ãƒ•ãƒ©å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ« - åŒ…æ‹¬çš„ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒƒãƒ”ãƒ³ã‚°</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .checkbox-groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .checkbox-group {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.8rem;
            background: #f8f9fa;
        }

        .checkbox-group-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #dee2e6;
        }

        .checkbox-group-items {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .map-container {
            margin: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        #map {
            height: 600px;
            width: 100%;
        }

        .status {
            margin: 1rem;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .legend {
            background: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .marker-surveillance { background: #e74c3c; }
        .marker-tower { background: #3498db; }
        .marker-wifi { background: #f39c12; }
        .marker-police { background: #c0392b; }
        .marker-emergency { background: #e67e22; }
        .marker-antenna { background: #9b59b6; }
        .marker-substation { background: #f1c40f; }
        .marker-power_pole { background: #d68910; }
        .marker-generator { background: #28b463; }
        .marker-traffic_signals { background: #dc143c; }
        .marker-speed_camera { background: #8b0000; }
        .marker-fuel_station { background: #ff6b6b; }
        .marker-atm { background: #2ecc71; }
        .marker-post_box { background: #e74c3c; }
        .marker-waste_disposal { background: #7f8c8d; }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-popup-content {
            width: auto !important;
            max-width: 400px !important;
            min-width: 300px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin: -10px -10px 15px -10px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 16px;
        }

        .popup-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }

        .popup-table th {
            background: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            width: 35%;
        }

        .popup-table td {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            color: #212529;
            word-break: break-word;
        }

        .popup-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .popup-table tr:hover {
            background: #e9ecef;
        }

        .popup-metadata {
            font-size: 12px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
            margin-top: 15px;
        }

        .popup-coordinates {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .popup-tag-category {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
        }

        .popup-external-links {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .popup-external-links a {
            display: inline-block;
            margin-right: 10px;
            padding: 4px 8px;
            background: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }

        .popup-external-links a:hover {
            background: #138496;
        }
        .marker-cluster {
            background: rgba(102, 126, 234, 0.6);
            border: 3px solid rgba(102, 126, 234, 0.8);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .marker-cluster-small {
            width: 40px;
            height: 40px;
            line-height: 37px;
        }

        .marker-cluster-medium {
            width: 50px;
            height: 50px;
            line-height: 47px;
            font-size: 16px;
        }

        .marker-cluster-large {
            width: 60px;
            height: 60px;
            line-height: 57px;
            font-size: 18px;
        }

        /* ã‚¤ãƒ³ãƒ•ãƒ©ç¨®åˆ¥ã”ã¨ã®ã‚¯ãƒ©ã‚¹ã‚¿è‰² */
        .cluster-surveillance {
            background: rgba(231, 76, 60, 0.6);
            border-color: rgba(231, 76, 60, 0.8);
        }

        .cluster-tower {
            background: rgba(52, 152, 219, 0.6);
            border-color: rgba(52, 152, 219, 0.8);
        }

        .cluster-wifi {
            background: rgba(243, 156, 18, 0.6);
            border-color: rgba(243, 156, 18, 0.8);
        }

        .cluster-mixed {
            background: rgba(149, 165, 166, 0.6);
            border-color: rgba(149, 165, 166, 0.8);
        }

        #debug-controls {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed #95a5a6;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        #debug-controls::before {
            content: "ğŸ”§ é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«:";
            font-weight: 600;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .dev-mode-btn {
            font-size: 0.85rem !important;
            padding: 0.6rem 1.2rem !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .dev-mode-btn:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .controls {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            .checkbox-groups-container {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .checkbox-group {
                padding: 0.6rem;
            }
            
            .checkbox-group-items {
                gap: 0.2rem;
            }
            
            #debug-controls {
                margin-top: 0.8rem;
                padding: 0.8rem;
                gap: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
            }
            
            #map {
                height: 500px;
            }
            
            .legend {
                margin: 0.5rem;
            }
            
            .legend > div[style*="grid"] {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èª¿æ•´ */
            .leaflet-popup-content {
                max-width: 280px !important;
                min-width: 250px !important;
            }
            
            .popup-table {
                font-size: 12px;
            }
            
            .popup-table th,
            .popup-table td {
                padding: 6px 8px;
            }
            
            .popup-external-links a {
                display: block;
                margin: 5px 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ OSMã‚¤ãƒ³ãƒ•ãƒ©å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ï¼ˆOSM Infrastructure Viewerï¼‰</h1>
        <p>OpenStreetMapã®å¤šæ§˜ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆç›£è¦–ã€é€šä¿¡ã€é›»åŠ›ã€äº¤é€šç­‰ï¼‰ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>è¡¨ç¤ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="surveillance" value="surveillance" checked>
                    <label for="surveillance">CCTVã‚«ãƒ¡ãƒ©</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="tower" value="tower" checked>
                    <label for="tower">æºå¸¯åŸºåœ°å±€</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="wifi" value="wifi" checked>
                    <label for="wifi">Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ</label>
                </div>
            </div>
        </div>
        <button class="search-btn" onclick="searchInfrastructure()">ğŸ” æ¤œç´¢</button>
        <button class="search-btn" onclick="showClusterInfo()" style="background: #8e44ad;">ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±</button>
        <button class="search-btn" onclick="showExportOptions()" style="background: #17a2b8;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</button>
        <button class="search-btn dev-mode-btn" onclick="toggleDebugMode()" style="background: #6c757d;">âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</button>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º -->
        <div id="debug-controls" style="display: none;">
            <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
            <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
            <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="legend">
        <h3>å‡¡ä¾‹ï¼ˆä¸»è¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
            <div>
                <strong>ğŸ”’ ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-surveillance"></div>
                    <span>ğŸ“¹ CCTVã‚«ãƒ¡ãƒ©</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-police"></div>
                    <span>ğŸš“ è­¦å¯Ÿé–¢é€£</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-emergency"></div>
                    <span>ğŸ†˜ ç·Šæ€¥é›»è©±</span>
                </div>
            </div>
            
            <div>
                <strong>ğŸ“¡ é€šä¿¡ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-tower"></div>
                    <span>ğŸ“¡ æºå¸¯åŸºåœ°å±€</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-wifi"></div>
                    <span>ğŸ“¶ Wi-Fi</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-antenna"></div>
                    <span>ğŸ“» ã‚¢ãƒ³ãƒ†ãƒŠ</span>
                </div>
            </div>
            
            <div>
                <strong>âš¡ é›»åŠ›ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-substation"></div>
                    <span>âš¡ å¤‰é›»æ‰€</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-power_pole"></div>
                    <span>ğŸ—¼ é›»æŸ±ãƒ»é‰„å¡”</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-generator"></div>
                    <span>ğŸ”‹ ç™ºé›»æ©Ÿ</span>
                </div>
            </div>
            
            <div>
                <strong>ğŸš¦ äº¤é€šãƒ»ãã®ä»–</strong>
                <div class="legend-item">
                    <div class="legend-marker marker-traffic_signals"></div>
                    <span>ğŸš¦ ä¿¡å·æ©Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-atm"></div>
                    <span>ğŸ§ ATM</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker marker-fuel_station"></div>
                    <span>â›½ ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰</span>
                </div>
            </div>
        </div>
        
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>ğŸ” è©³ç´°æƒ…å ±è¡¨ç¤º</strong><br>
            ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãªæƒ…å ±ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚OSMã‚¿ã‚°ã€åº§æ¨™ã€å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’å«ã‚€åŒ…æ‹¬çš„ãªæƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
            <strong>å¤–éƒ¨ãƒªãƒ³ã‚¯:</strong> OpenStreetMapã€Google Mapsã€Street View ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
        </div>
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½</strong><br>
            å¯†é›†ã‚¨ãƒªã‚¢ã§ã¯è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚ºãƒ¼ãƒ ã—ã¦è©³ç´°è¡¨ç¤ºã€‚<br>
            ã€ŒğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã€ãƒœã‚¿ãƒ³ã§çµ±è¨ˆæƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
            <span style="color: #e74c3c;">â—</span> ç›£è¦–ã‚«ãƒ¡ãƒ©ä¸»ä½“
            <span style="color: #3498db;">â—</span> åŸºåœ°å±€ä¸»ä½“
            <span style="color: #f39c12;">â—</span> Wi-Fiä¸»ä½“
            <span style="color: #95a5a6;">â—</span> æ··åœ¨
        </div>
        <hr style="margin: 10px 0; border-color: #eee;">
        <div style="font-size: 0.85rem; color: #666;">
            <strong>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›æ©Ÿèƒ½</strong><br>
            å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’GeoJSON/KMLå½¢å¼ã§å‡ºåŠ›å¯èƒ½ã€‚QGISã€Google Earthã€ArcGISç­‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚<br>
            <strong>GeoJSON:</strong> Webç”¨ã€è»½é‡ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å‘ã‘ï½œ<strong>KML:</strong> Google Earthç”¨ã€è¦–è¦šçš„
        </div>
    </div>

    <div style="margin-top: 30px; padding: 15px; text-align: center; border-top: 1px solid #000000; color: #6c757d;">
        ğŸ”— GitHubãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ï¼ˆ<a href="https://github.com/ipusiron/osm-infra-viewer" target="_blank" style="color: #007bff; text-decoration: none;">ipusiron/osm-infra-viewer</a>ï¼‰
        <br>
        <small style="font-size: 0.7rem; color: #aaa; margin-top: 5px; display: inline-block;">
            ğŸ’¡ ä¸Šéƒ¨ã®ã€Œâš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™
        </small>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet MarkerCluster JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    
    <script>
        // åœ°å›³ã®åˆæœŸåŒ–
        let map = L.map('map').setView([35.6762, 139.6503], 13); // æ±äº¬é§…ä»˜è¿‘

        // OpenStreetMapã‚¿ã‚¤ãƒ«è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
        let markersGroup = L.markerClusterGroup({
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®è¨­å®š
            maxClusterRadius: 50, // ã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã™ã‚‹æœ€å¤§è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            spiderfyOnMaxZoom: true, // æœ€å¤§ã‚ºãƒ¼ãƒ æ™‚ã«ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼è¡¨ç¤º
            showCoverageOnHover: false, // ãƒ›ãƒãƒ¼æ™‚ã®ç¯„å›²è¡¨ç¤ºã‚’ç„¡åŠ¹
            zoomToBoundsOnClick: true, // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ºãƒ¼ãƒ 
            disableClusteringAtZoom: 18, // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«18ä»¥ä¸Šã§ã‚¯ãƒ©ã‚¹ã‚¿ç„¡åŠ¹
            
            // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ã‚¿ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
            iconCreateFunction: function(cluster) {
                const markers = cluster.getAllChildMarkers();
                let surveillanceCount = 0;
                let towerCount = 0;
                let wifiCount = 0;
                
                // å„ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                markers.forEach(marker => {
                    const type = marker.options.infraType;
                    if (type === 'surveillance') surveillanceCount++;
                    else if (type === 'tower') towerCount++;
                    else if (type === 'wifi') wifiCount++;
                });
                
                const childCount = cluster.getChildCount();
                let clusterClass = 'marker-cluster-';
                let infraClass = 'cluster-mixed';
                
                // ã‚µã‚¤ã‚ºã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
                if (childCount < 10) {
                    clusterClass += 'small';
                } else if (childCount < 50) {
                    clusterClass += 'medium';
                } else {
                    clusterClass += 'large';
                }
                
                // ä¸»è¦ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¿ã‚¤ãƒ—ã‚’æ±ºå®š
                const maxCount = Math.max(surveillanceCount, towerCount, wifiCount);
                if (surveillanceCount === maxCount && surveillanceCount > childCount * 0.6) {
                    infraClass = 'cluster-surveillance';
                } else if (towerCount === maxCount && towerCount > childCount * 0.6) {
                    infraClass = 'cluster-tower';
                } else if (wifiCount === maxCount && wifiCount > childCount * 0.6) {
                    infraClass = 'cluster-wifi';
                }
                
                return new L.DivIcon({
                    html: `<div><span>${childCount}</span></div>`,
                    className: `marker-cluster ${clusterClass} ${infraClass}`,
                    iconSize: new L.Point(40, 40)
                });
            }
        }).addTo(map);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Overpass APIã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
        function buildOverpassQuery(bounds) {
            const selectedTypes = [];
            
            // å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã®OSMã‚¿ã‚°å®šç¾©
            const objectTypes = {
                surveillance: ['man_made=surveillance', 'surveillance'],
                police: ['amenity=police', 'emergency=police'],
                emergency: ['emergency=phone', 'amenity=emergency_phone'],
                tower: ['man_made=communications_tower', 'man_made=tower', 'tower:type=communication'],
                wifi: ['internet_access=wlan', 'amenity=internet_cafe'],
                antenna: ['man_made=mast', 'man_made=antenna'],
                substation: ['power=substation', 'power=station'],
                power_pole: ['power=pole', 'power=tower', 'man_made=utility_pole'],
                generator: ['power=generator', 'man_made=generator'],
                traffic_signals: ['highway=traffic_signals'],
                speed_camera: ['highway=speed_camera', 'man_made=monitoring_station'],
                fuel_station: ['amenity=fuel'],
                atm: ['amenity=atm'],
                post_box: ['amenity=post_box'],
                waste_disposal: ['amenity=waste_disposal', 'man_made=waste_disposal']
            };

            // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’åé›†
            Object.keys(objectTypes).forEach(type => {
                if (document.getElementById(type) && document.getElementById(type).checked) {
                    selectedTypes.push({type: type, tags: objectTypes[type]});
                }
            });

            if (selectedTypes.length === 0) {
                return null;
            }

            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query = '[out:json][timeout:25];\n(\n';
            
            selectedTypes.forEach(typeInfo => {
                typeInfo.tags.forEach(tag => {
                    if (tag.includes('=')) {
                        const [key, value] = tag.split('=');
                        query += `  node["${key}"="${value}"](${bbox});\n`;
                        query += `  way["${key}"="${value}"](${bbox});\n`;
                    } else {
                        // å±æ€§ã®ã¿æŒ‡å®šï¼ˆå€¤ã¯ä»»æ„ï¼‰
                        query += `  node["${tag}"](${bbox});\n`;
                        query += `  way["${tag}"](${bbox});\n`;
                    }
                });
            });
            
            query += ');\nout center meta;';
            
            return query;
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®š
        function getMarkerInfo(element) {
            const tags = element.tags || {};
            
            // ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç³»
            if (tags.man_made === 'surveillance' || tags.surveillance) {
                return {
                    color: '#e74c3c',
                    icon: 'ğŸ“¹',
                    type: 'CCTVã‚«ãƒ¡ãƒ©',
                    infraType: 'surveillance'
                };
            } else if (tags.amenity === 'police' || tags.emergency === 'police') {
                return {
                    color: '#c0392b',
                    icon: 'ğŸš“',
                    type: 'è­¦å¯Ÿé–¢é€£æ–½è¨­',
                    infraType: 'police'
                };
            } else if (tags.emergency === 'phone' || tags.amenity === 'emergency_phone') {
                return {
                    color: '#e67e22',
                    icon: 'ğŸ†˜',
                    type: 'ç·Šæ€¥é›»è©±',
                    infraType: 'emergency'
                };
            }
            
            // é€šä¿¡ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»
            else if (tags.man_made === 'communications_tower' || tags.man_made === 'tower' || tags['tower:type'] === 'communication') {
                return {
                    color: '#3498db',
                    icon: 'ğŸ“¡',
                    type: 'æºå¸¯åŸºåœ°å±€',
                    infraType: 'tower'
                };
            } else if (tags.internet_access === 'wlan' || tags.amenity === 'internet_cafe') {
                return {
                    color: '#f39c12',
                    icon: 'ğŸ“¶',
                    type: 'Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ',
                    infraType: 'wifi'
                };
            } else if (tags.man_made === 'mast' || tags.man_made === 'antenna') {
                return {
                    color: '#9b59b6',
                    icon: 'ğŸ“»',
                    type: 'ã‚¢ãƒ³ãƒ†ãƒŠãƒ»ãƒã‚¹ãƒˆ',
                    infraType: 'antenna'
                };
            }
            
            // é›»åŠ›ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ç³»
            else if (tags.power === 'substation' || tags.power === 'station') {
                return {
                    color: '#f1c40f',
                    icon: 'âš¡',
                    type: 'å¤‰é›»æ‰€',
                    infraType: 'substation'
                };
            } else if (tags.power === 'pole' || tags.power === 'tower' || tags.man_made === 'utility_pole') {
                return {
                    color: '#d68910',
                    icon: 'ğŸ—¼',
                    type: 'é›»æŸ±ãƒ»é‰„å¡”',
                    infraType: 'power_pole'
                };
            } else if (tags.power === 'generator' || tags.man_made === 'generator') {
                return {
                    color: '#28b463',
                    icon: 'ğŸ”‹',
                    type: 'ç™ºé›»æ©Ÿ',
                    infraType: 'generator'
                };
            }
            
            // äº¤é€šãƒ»è¼¸é€ç³»
            else if (tags.highway === 'traffic_signals') {
                return {
                    color: '#dc143c',
                    icon: 'ğŸš¦',
                    type: 'ä¿¡å·æ©Ÿ',
                    infraType: 'traffic_signals'
                };
            } else if (tags.highway === 'speed_camera' || tags.man_made === 'monitoring_station') {
                return {
                    color: '#8b0000',
                    icon: 'ğŸ“¸',
                    type: 'äº¤é€šç›£è¦–ã‚«ãƒ¡ãƒ©',
                    infraType: 'speed_camera'
                };
            } else if (tags.amenity === 'fuel') {
                return {
                    color: '#ff6b6b',
                    icon: 'â›½',
                    type: 'ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰',
                    infraType: 'fuel_station'
                };
            }
            
            // ãã®ä»–ã®ã‚¤ãƒ³ãƒ•ãƒ©
            else if (tags.amenity === 'atm') {
                return {
                    color: '#2ecc71',
                    icon: 'ğŸ§',
                    type: 'ATM',
                    infraType: 'atm'
                };
            } else if (tags.amenity === 'post_box') {
                return {
                    color: '#e74c3c',
                    icon: 'ğŸ“®',
                    type: 'éƒµä¾¿ãƒã‚¹ãƒˆ',
                    infraType: 'post_box'
                };
            } else if (tags.amenity === 'waste_disposal' || tags.man_made === 'waste_disposal') {
                return {
                    color: '#7f8c8d',
                    icon: 'ğŸ—‘ï¸',
                    type: 'ã‚´ãƒŸå‡¦ç†æ–½è¨­',
                    infraType: 'waste_disposal'
                };
            }
            
            return {
                color: '#95a5a6',
                icon: 'ğŸ“',
                type: 'ãã®ä»–',
                infraType: 'other'
            };
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’ç”Ÿæˆï¼ˆæ‹¡å¼µç‰ˆï¼‰
        function generatePopupContent(element, markerInfo) {
            const tags = element.tags || {};
            const lat = element.lat || (element.center ? element.center.lat : 0);
            const lon = element.lon || (element.center ? element.center.lon : 0);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            let content = `<div class="popup-header">
                ${markerInfo.icon} ${markerInfo.type}
            </div>`;
            
            // åŸºæœ¬æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
            content += `<table class="popup-table">`;
            
            // é‡è¦ãªã‚¿ã‚°ã‚’å„ªå…ˆè¡¨ç¤º
            const priorityTags = [
                { key: 'name', label: 'åç§°', category: 'åŸºæœ¬' },
                { key: 'operator', label: 'é‹å–¶è€…', category: 'åŸºæœ¬' },
                { key: 'surveillance:type', label: 'ç›£è¦–ã‚¿ã‚¤ãƒ—', category: 'ç›£è¦–' },
                { key: 'surveillance:zone', label: 'ç›£è¦–ç¯„å›²', category: 'ç›£è¦–' },
                { key: 'camera:type', label: 'ã‚«ãƒ¡ãƒ©ç¨®åˆ¥', category: 'ç›£è¦–' },
                { key: 'camera:mount', label: 'è¨­ç½®æ–¹æ³•', category: 'ç›£è¦–' },
                { key: 'height', label: 'é«˜ã•', category: 'ç‰©ç†' },
                { key: 'tower:type', label: 'ã‚¿ãƒ¯ãƒ¼ç¨®åˆ¥', category: 'é€šä¿¡' },
                { key: 'communication:mobile_phone', label: 'æºå¸¯é›»è©±å¯¾å¿œ', category: 'é€šä¿¡' },
                { key: 'communication:radio', label: 'ãƒ©ã‚¸ã‚ªå¯¾å¿œ', category: 'é€šä¿¡' },
                { key: 'internet_access', label: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ', category: 'ãƒãƒƒãƒˆ' },
                { key: 'internet_access:fee', label: 'åˆ©ç”¨æ–™é‡‘', category: 'ãƒãƒƒãƒˆ' },
                { key: 'wifi', label: 'Wi-Fi', category: 'ãƒãƒƒãƒˆ' },
                { key: 'addr:street', label: 'è¡—è·¯', category: 'ä½æ‰€' },
                { key: 'addr:housenumber', label: 'ç•ªåœ°', category: 'ä½æ‰€' },
                { key: 'addr:city', label: 'å¸‚åŒºç”ºæ‘', category: 'ä½æ‰€' }
            ];
            
            // å„ªå…ˆã‚¿ã‚°ã‚’è¡¨ç¤º
            let displayedTags = new Set();
            priorityTags.forEach(tagInfo => {
                if (tags[tagInfo.key]) {
                    content += `<tr>
                        <th><span class="popup-tag-category">${tagInfo.category}</span>${tagInfo.label}</th>
                        <td>${escapeHtml(tags[tagInfo.key])}</td>
                    </tr>`;
                    displayedTags.add(tagInfo.key);
                }
            });
            
            // ãã®ä»–ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
            const otherTags = Object.keys(tags)
                .filter(key => !displayedTags.has(key) && !['man_made', 'amenity'].includes(key))
                .sort();
                
            if (otherTags.length > 0) {
                content += `<tr><th colspan="2" style="background: #e9ecef; text-align: center; font-weight: bold;">ãã®ä»–ã®å±æ€§</th></tr>`;
                otherTags.forEach(key => {
                    const value = tags[key];
                    if (value && value.length > 0) {
                        content += `<tr>
                            <th><span class="popup-tag-category">ãã®ä»–</span>${escapeHtml(key)}</th>
                            <td>${escapeHtml(value)}</td>
                        </tr>`;
                    }
                });
            }
            
            content += `</table>`;
            
            // å¤–éƒ¨ãƒªãƒ³ã‚¯
            content += `<div class="popup-external-links">
                <a href="https://www.openstreetmap.org/${element.type}/${element.id}" target="_blank">ğŸ“ OSMã§è¦‹ã‚‹</a>
                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">ğŸ—ºï¸ Google Maps</a>
            `;
            
            // ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ï¼ˆç²¾åº¦ãŒé«˜ã„å ´åˆã®ã¿ï¼‰
            if (lat && lon && Math.abs(lat) > 0.001 && Math.abs(lon) > 0.001) {
                content += `<a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}" target="_blank">ğŸ‘ï¸ Street View</a>`;
            }
            
            content += `</div>`;
            
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
            content += `<div class="popup-metadata">
                <div><strong>åº§æ¨™:</strong> <span class="popup-coordinates">${lat.toFixed(6)}, ${lon.toFixed(6)}</span></div>
                <div><strong>OSM ID:</strong> ${element.type}/${element.id}</div>
                <div><strong>ãƒ‡ãƒ¼ã‚¿å–å¾—:</strong> ${new Date().toLocaleDateString('ja-JP')} ${new Date().toLocaleTimeString('ja-JP')}</div>
                <div><strong>å‡ºå…¸:</strong> Â© OpenStreetMap contributors</div>
            </div>`;
            
            return content;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        function addMarkersToMap(data) {
            console.log('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ é–‹å§‹');
            markersGroup.clearLayers();
            let count = 0;
            let skippedCount = 0;

            if (!data.elements || data.elements.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                showStatus('ã“ã®ç¯„å›²ã«ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                return;
            }

            data.elements.forEach((element, index) => {
                let lat, lon;
                
                if (element.lat && element.lon) {
                    lat = element.lat;
                    lon = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lon = element.center.lon;
                } else if (element.geometry && element.geometry.length > 0) {
                    lat = element.geometry[0].lat;
                    lon = element.geometry[0].lon;
                } else {
                    console.log(`âš ï¸ åº§æ¨™ãªã— [${index}]:`, element);
                    skippedCount++;
                    return; // åº§æ¨™ãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                const markerInfo = getMarkerInfo(element);
                console.log(`ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ [${index}]: ${markerInfo.type} at ${lat}, ${lon}`);
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: markerInfo.color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    infraType: markerInfo.infraType // ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç”¨ã®ã‚¿ã‚¤ãƒ—æƒ…å ±
                });

                const popupContent = generatePopupContent(element, markerInfo);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                const popupOptions = {
                    maxWidth: 450,
                    minWidth: 350,
                    autoPan: true,
                    closeButton: true,
                    autoClose: false,
                    className: 'custom-popup'
                };
                
                marker.bindPopup(popupContent, popupOptions);
                
                // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                marker.on('click', function(e) {
                    console.log(`ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯: ${markerInfo.type} at ${lat}, ${lon}`);
                    console.log('OSMã‚¿ã‚°:', element.tags);
                });
                
                markersGroup.addLayer(marker);
                count++;
            });

            console.log(`âœ… ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ å®Œäº†: ${count}å€‹è¡¨ç¤º, ${skippedCount}å€‹ã‚¹ã‚­ãƒƒãƒ—`);
            
            if (count === 0) {
                showStatus(`ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã—ãŸãŒã€è¡¨ç¤ºå¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå–å¾—è¦ç´ æ•°: ${data.elements.length}ï¼‰`, 'error');
            } else {
                showStatus(`${count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
            }
        }

        // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’æ¤œç´¢
        async function searchInfrastructure() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            
            if (!query) {
                showStatus('æ¤œç´¢ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            console.log('ğŸ” æ¤œç´¢é–‹å§‹');
            console.log('æ¤œç´¢ç¯„å›²:', bounds);
            console.log('ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:', map.getZoom());
            console.log('Overpassã‚¯ã‚¨ãƒª:', query);

            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'loading');
            
            const searchBtn = document.querySelector('.search-btn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'æ¤œç´¢ä¸­...';

            try {
                //è¤‡æ•°ã®Overpass APIã‚µãƒ¼ãƒãƒ¼ã‚’è©¦ã™
                const apiUrls = [
                    'https://overpass-api.de/api/interpreter',
                    'https://lz4.overpass-api.de/api/interpreter',
                    'https://z.overpass-api.de/api/interpreter'
                ];
                
                let response;
                let lastError;
                
                for (const apiUrl of apiUrls) {
                    try {
                        console.log(`ğŸŒ APIè©¦è¡Œ: ${apiUrl}`);
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: 'data=' + encodeURIComponent(query)
                        });
                        
                        if (response.ok) {
                            console.log(`âœ… APIæˆåŠŸ: ${apiUrl}`);
                            break;
                        } else {
                            console.log(`âŒ APIå¤±æ•—: ${apiUrl}, status: ${response.status}`);
                            lastError = new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.log(`âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${apiUrl}`, error);
                        lastError = error;
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw lastError || new Error('ã™ã¹ã¦ã®APIã‚µãƒ¼ãƒãƒ¼ã§å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                console.log('ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
                console.log('è¦ç´ æ•°:', data.elements ? data.elements.length : 0);
                
                addMarkersToMap(data);
                
            } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                showStatus('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ğŸ” æ¤œç´¢';
            }
        }

        // åœ°å›³ç§»å‹•æ™‚ã®å‡¦ç†
        map.on('moveend', function() {
            const zoom = map.getZoom();
            if (zoom < 10) {
                showStatus('è©³ç´°ãªæ¤œç´¢ã«ã¯åœ°å›³ã‚’ã‚ˆã‚Šæ‹¡å¤§ã—ã¦ãã ã•ã„ï¼ˆã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«10ä»¥ä¸Šæ¨å¥¨ï¼‰', 'error');
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        window.addEventListener('load', function() {
            initializeDebugMode(); // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
            showStatus('ãŠå¥½ã¿ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã€åœ°å›³ã‚’ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ ã—ã¦ã‹ã‚‰æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'success');
        });

        // ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆç°¡å˜ãƒ†ã‚¹ãƒˆç”¨ï¼‰
        function createTestMarker(lat, lon, tags, type) {
            const markerInfo = {
                color: '#27ae60',
                icon: 'ğŸ§ª',
                type: 'ãƒ†ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ',
                infraType: 'test'
            };
            
            const marker = L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: markerInfo.color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
                infraType: 'test'
            });
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®è©³ç´°ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
            const testElement = {
                id: `test_${Date.now()}`,
                type: 'node',
                lat: lat,
                lon: lon,
                tags: tags
            };
            
            const popupContent = generatePopupContent(testElement, markerInfo);
            const popupOptions = {
                maxWidth: 450,
                minWidth: 350,
                autoPan: true,
                closeButton: true,
                autoClose: false,
                className: 'custom-popup'
            };
            
            marker.bindPopup(popupContent, popupOptions);
            return marker;
        }

        // ç°¡å˜ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        async function testSimpleQuery() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªï¼ˆATMã‚’æ¤œç´¢ï¼‰
            const simpleQuery = `[out:json][timeout:25];
(
  node["amenity"="atm"](${bbox});
  node["amenity"="bank"](${bbox});
  node["shop"="convenience"](${bbox});
);
out center meta;`;

            console.log('ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆé–‹å§‹');
            console.log('ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒª:', simpleQuery);
            
            showStatus('ç°¡å˜ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ï¼ˆATMãƒ»éŠ€è¡Œãƒ»ã‚³ãƒ³ãƒ“ãƒ‹ã‚’æ¤œç´¢ï¼‰...', 'loading');
            
            try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(simpleQuery)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ:', data);
                
                markersGroup.clearLayers();
                let count = 0;
                
                data.elements.forEach(element => {
                    if (element.lat && element.lon) {
                        const marker = createTestMarker(element.lat, element.lon, element.tags || {
                            name: element.tags?.name || 'ãƒ†ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ',
                            amenity: element.tags?.amenity || element.tags?.shop || 'unknown',
                            operator: element.tags?.operator || 'ä¸æ˜',
                            'addr:city': element.tags?.['addr:city'] || '',
                            'test:timestamp': new Date().toISOString()
                        }, element.tags?.amenity || element.tags?.shop || 'test');
                        
                        markersGroup.addLayer(marker);
                        count++;
                    }
                });
                
                showStatus(`ãƒ†ã‚¹ãƒˆæˆåŠŸï¼${count}å€‹ã®ãƒ†ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º`, 'success');
                
                // Overpass Turboãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(simpleQuery)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('ğŸ”— Overpass Turboã§ç¢ºèª:', turboUrl);
                
            } catch (error) {
                console.error('ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message, 'error');
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function showExportOptions() {
            const totalMarkers = markersGroup.getLayers().length;
            
            if (totalMarkers === 0) {
                showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
            const dialogHtml = `
                <div id="export-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 1rem 0; color: #333; text-align: center;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                        <p style="margin: 0 0 1.5rem 0; color: #666; text-align: center;">ç¾åœ¨${totalMarkers}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã™ã€‚<br>ã©ã®å½¢å¼ã§å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ</p>
                        
                        <div style="display: grid; gap: 0.8rem;">
                            <button onclick="exportToGeoJSON(); closeExportDialog();" style="padding: 0.8rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                ğŸ“„ GeoJSONå½¢å¼ã§å‡ºåŠ›<br>
                                <small style="opacity: 0.8;">Webç”¨ãƒ»è»½é‡ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å‘ã‘</small>
                            </button>
                            
                            <button onclick="exportToKML(); closeExportDialog();" style="padding: 0.8rem; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                ğŸŒ KMLå½¢å¼ã§å‡ºåŠ›<br>
                                <small style="opacity: 0.8;">Google Earthç”¨ãƒ»è¦–è¦šçš„</small>
                            </button>
                            
                            <button onclick="closeExportDialog();" style="padding: 0.8rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
        }

        // å…¨é¸æŠãƒ»å…¨è§£é™¤æ©Ÿèƒ½
        function toggleAllObjects(enable) {
            const objectTypes = [
                'surveillance', 'police', 'emergency',
                'tower', 'wifi', 'antenna',
                'substation', 'power_pole', 'generator',
                'traffic_signals', 'speed_camera', 'fuel_station',
                'atm', 'post_box', 'waste_disposal'
            ];
            
            objectTypes.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    element.checked = enable;
                }
            });
            
            showStatus(enable ? 'å…¨ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¾ã—ãŸ' : 'å…¨ã¦ã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥é¸æŠæ©Ÿèƒ½
        function toggleCategory(category) {
            const categories = {
                security: ['surveillance', 'police', 'emergency'],
                communication: ['tower', 'wifi', 'antenna'],
                power: ['substation', 'power_pole', 'generator'],
                traffic: ['traffic_signals', 'speed_camera', 'fuel_station'],
                other: ['atm', 'post_box', 'waste_disposal']
            };
            
            const types = categories[category];
            if (!types) return;
            
            // ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’ç¢ºèª
            const currentStates = types.map(type => {
                const element = document.getElementById(type);
                return element ? element.checked : false;
            });
            
            // å…¨ã¦é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤ã€ãã†ã§ãªã‘ã‚Œã°å…¨é¸æŠ
            const allSelected = currentStates.every(state => state);
            const newState = !allSelected;
            
            types.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    element.checked = newState;
                }
            });
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeExportDialog() {
            const dialog = document.getElementById('export-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // GeoJSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToGeoJSON() {
            console.log('ğŸ“„ GeoJSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹');
            
            const features = [];
            
            markersGroup.eachLayer(function(layer) {
                if (layer.getLatLng && layer.options && layer.options.infraType) {
                    const latlng = layer.getLatLng();
                    const popupContent = layer.getPopup()?.getContent() || '';
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚¿ã‚°æƒ…å ±ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    const infraType = layer.options.infraType;
                    let name = 'Unknown';
                    let operator = '';
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ã‹ã‚‰åå‰ã¨é‹å–¶è€…ã‚’æŠ½å‡º
                    const nameMatch = popupContent.match(/<strong>name:<\/strong>\s*([^<]+)/);
                    const operatorMatch = popupContent.match(/<strong>operator:<\/strong>\s*([^<]+)/);
                    
                    if (nameMatch) name = nameMatch[1].trim();
                    if (operatorMatch) operator = operatorMatch[1].trim();

                    const feature = {
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: [latlng.lng, latlng.lat]
                        },
                        properties: {
                            name: name,
                            infraType: infraType,
                            operator: operator,
                            exportedAt: new Date().toISOString(),
                            source: "OpenStreetMap via OSM Infrastructure Viewer"
                        }
                    };
                    
                    features.push(feature);
                }
            });

            const geoJSON = {
                type: "FeatureCollection",
                metadata: {
                    title: "OSM Infrastructure Data",
                    description: "Infrastructure objects from OpenStreetMap",
                    generator: "OSM Infrastructure Viewer by IPUSIRON",
                    exportedAt: new Date().toISOString(),
                    count: features.length
                },
                features: features
            };

            const jsonString = JSON.stringify(geoJSON, null, 2);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `osm-infrastructure-${timestamp}.geojson`;
            
            downloadFile(jsonString, filename, 'application/geo+json');
            showStatus(`GeoJSONå½¢å¼ã§${features.length}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ`, 'success');
            
            console.log('âœ… GeoJSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†:', features.length, 'features');
        }

        // KMLå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToKML() {
            console.log('ğŸ“„ KMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹');
            
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>OSM Infrastructure Data</name>
    <description>Infrastructure objects from OpenStreetMap exported by OSM Infrastructure Viewer</description>
    
    <!-- Styles for different infrastructure types -->
    <Style id="surveillance">
      <IconStyle>
        <color>ff3c4ce7</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/surveillance.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="tower">
      <IconStyle>
        <color>ffdb5234</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/phone.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="wifi">
      <IconStyle>
        <color>ff12f39c</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/wifi.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <!-- Infrastructure Objects -->
`;

            let count = 0;
            markersGroup.eachLayer(function(layer) {
                if (layer.getLatLng && layer.options && layer.options.infraType) {
                    const latlng = layer.getLatLng();
                    const popupContent = layer.getPopup()?.getContent() || '';
                    const infraType = layer.options.infraType;
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚¿ã‚°æƒ…å ±ã‚’æŠ½å‡º
                    let name = `Infrastructure Object ${count + 1}`;
                    let operator = '';
                    let description = popupContent.replace(/<[^>]*>/g, ''); // HTMLã‚¿ã‚°ã‚’é™¤å»
                    
                    const nameMatch = popupContent.match(/<strong>name:<\/strong>\s*([^<]+)/);
                    const operatorMatch = popupContent.match(/<strong>operator:<\/strong>\s*([^<]+)/);
                    
                    if (nameMatch) name = nameMatch[1].trim();
                    if (operatorMatch) operator = operatorMatch[1].trim();

                    const infraTypeNames = {
                        surveillance: 'CCTV Camera',
                        tower: 'Communication Tower',
                        wifi: 'Wi-Fi Hotspot',
                        other: 'Other Infrastructure'
                    };

                    kmlContent += `    <Placemark>
      <name>${escapeXml(name)}</name>
      <description><![CDATA[
        <b>Type:</b> ${infraTypeNames[infraType] || infraType}<br/>
        <b>Operator:</b> ${escapeXml(operator)}<br/>
        <b>Coordinates:</b> ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}<br/>
        <b>Source:</b> OpenStreetMap<br/>
        <hr/>
        ${description}
      ]]></description>
      <styleUrl>#${infraType}</styleUrl>
      <Point>
        <coordinates>${latlng.lng},${latlng.lat},0</coordinates>
      </Point>
    </Placemark>
`;
                    count++;
                }
            });

            kmlContent += `  </Document>
</kml>`;

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `osm-infrastructure-${timestamp}.kml`;
            
            downloadFile(kmlContent, filename, 'application/vnd.google-earth.kml+xml');
            showStatus(`KMLå½¢å¼ã§${count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ`, 'success');
            
            console.log('âœ… KMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†:', count, 'placemarks');
        }

        // XMLç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${filename} (${(blob.size / 1024).toFixed(1)} KB)`);
        }

        // ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±è¡¨ç¤ºï¼ˆé–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ï¼‰
        function showClusterInfo() {
            const totalMarkers = markersGroup.getLayers().length;
            const clusters = [];
            
            // è¡¨ç¤ºä¸­ã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åé›†
            markersGroup.eachLayer(function(layer) {
                if (layer instanceof L.MarkerCluster) {
                    const markers = layer.getAllChildMarkers();
                    let infraCounts = {};
                    
                    markers.forEach(marker => {
                        const type = marker.options.infraType || 'other';
                        infraCounts[type] = (infraCounts[type] || 0) + 1;
                    });
                    
                    clusters.push({
                        count: markers.length,
                        infraCounts: infraCounts,
                        bounds: layer.getBounds()
                    });
                }
            });
            
            console.log('ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æçµæœ');
            console.log('ç·ãƒãƒ¼ã‚«ãƒ¼æ•°:', totalMarkers);
            console.log('ã‚¯ãƒ©ã‚¹ã‚¿æ•°:', clusters.length);
            console.log('å¹³å‡ã‚¯ãƒ©ã‚¹ã‚¿ã‚µã‚¤ã‚º:', clusters.length > 0 ? (totalMarkers / clusters.length).toFixed(1) : 0);
            console.log('ã‚¯ãƒ©ã‚¹ã‚¿è©³ç´°:', clusters);
            
            // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            let infraTypeCounts = {};
            markersGroup.eachLayer(function(layer) {
                if (layer.options && layer.options.infraType) {
                    const type = layer.options.infraType;
                    infraTypeCounts[type] = (infraTypeCounts[type] || 0) + 1;
                }
            });
            
            const clusteringRatio = clusters.length > 0 ? ((totalMarkers - clusters.length) / totalMarkers * 100).toFixed(1) : 0;
            
            showStatus(`ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æå®Œäº† - ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç‡: ${clusteringRatio}%`, 'success');
            
            // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¿ã‚¤ãƒ—åˆ¥ã®çµ±è¨ˆã‚’è¡¨ç¤º
            const infraStatsText = Object.entries(infraTypeCounts)
                .map(([type, count]) => `${type}: ${count}`)
                .join('\n');
            
            alert(`ğŸ“Š ã‚¯ãƒ©ã‚¹ã‚¿åˆ†æçµæœ\n\nç·ãƒãƒ¼ã‚«ãƒ¼æ•°: ${totalMarkers}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${infraStatsText}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚¿æ•°: ${clusters.length}\nã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åŠ¹ç‡: ${clusteringRatio}%\n\nè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }

        // ãƒ†ã‚¹ãƒˆåœ°ç‚¹ã«ã‚¸ãƒ£ãƒ³ãƒ—
        function jumpToTestLocation() {
            // ç›£è¦–ã‚«ãƒ¡ãƒ©ã‚„é€šä¿¡è¨­å‚™ãŒå¤šã„åœ°åŸŸã‚’é¸æŠ
            const testLocations = [
                { name: 'ãƒ­ãƒ³ãƒ‰ãƒ³å¸‚å†…ï¼ˆç›£è¦–ã‚«ãƒ¡ãƒ©å¤šæ•°ï¼‰', lat: 51.5074, lng: -0.1278, zoom: 16 },
                { name: 'ãƒ™ãƒ«ãƒªãƒ³ä¸­å¤®é§…', lat: 52.5251, lng: 13.3693, zoom: 17 },
                { name: 'ãƒ‘ãƒª ã‚·ãƒ£ãƒ³ã‚¼ãƒªã‚¼', lat: 48.8738, lng: 2.2950, zoom: 17 },
                { name: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ ã‚¿ã‚¤ãƒ ã‚ºã‚¹ã‚¯ã‚¨ã‚¢', lat: 40.7580, lng: -73.9855, zoom: 17 },
                { name: 'æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«äº¤å·®ç‚¹', lat: 35.6595, lng: 139.7006, zoom: 18 },
                { name: 'æ–°å®¿é§…æ±å£', lat: 35.6896, lng: 139.7006, zoom: 17 }
            ];
            
            const location = testLocations[Math.floor(Math.random() * testLocations.length)];
            map.setView([location.lat, location.lng], location.zoom);
            showStatus(`${location.name}ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã—ãŸ`, 'success');
            console.log(`ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹: ${location.name} (${location.lat}, ${location.lng})`);
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            const bounds = map.getBounds();
            const query = buildOverpassQuery(bounds);
            const totalMarkers = markersGroup.getLayers().length;
            
            // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
            const objectTypes = ['surveillance', 'police', 'emergency', 'tower', 'wifi', 'antenna', 'substation', 'power_pole', 'generator', 'traffic_signals', 'speed_camera', 'fuel_station', 'atm', 'post_box', 'waste_disposal'];
            const selectedObjects = {};
            objectTypes.forEach(type => {
                const element = document.getElementById(type);
                if (element) {
                    selectedObjects[type] = element.checked;
                }
            });
            
            console.log('=== ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('ç¾åœ¨ä½ç½®:', map.getCenter());
            console.log('ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:', map.getZoom());
            console.log('æ¤œç´¢ç¯„å›²:', bounds);
            console.log('ç¯„å›²ã‚µã‚¤ã‚º (ç·¯åº¦):', bounds.getNorth() - bounds.getSouth());
            console.log('ç¯„å›²ã‚µã‚¤ã‚º (çµŒåº¦):', bounds.getEast() - bounds.getWest());
            console.log('é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:', selectedObjects);
            console.log('é¸æŠæ•°:', Object.values(selectedObjects).filter(v => v).length);
            console.log('ç·ãƒãƒ¼ã‚«ãƒ¼æ•°:', totalMarkers);
            console.log('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½:', totalMarkers > 0 ? 'Yes' : 'No');
            console.log('Overpassã‚¯ã‚¨ãƒª:', query);
            console.log('ãƒ–ãƒ©ã‚¦ã‚¶:', navigator.userAgent);
            console.log('HTTPS:', location.protocol === 'https:');
            
            // Overpass Turboãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
            if (query) {
                const turboUrl = `https://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}`;
                console.log('ğŸ”— Overpass Turboã§ç¢ºèª:', turboUrl);
            }
            console.log('===================');
            
            const selectedCount = Object.values(selectedObjects).filter(v => v).length;
            const turboLink = query ? `\n\nğŸ”— Overpass Turboã§ãƒ†ã‚¹ãƒˆ:\nhttps://overpass-turbo.eu/?Q=${encodeURIComponent(query)}&C=${map.getCenter().lat};${map.getCenter().lng};${map.getZoom()}` : '';
            
            alert(`ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚\n\nç¾åœ¨åœ°: ${map.getCenter().lat.toFixed(4)}, ${map.getCenter().lng.toFixed(4)}\nã‚ºãƒ¼ãƒ : ${map.getZoom()}\né¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: ${selectedCount}ç¨®é¡\nãƒãƒ¼ã‚«ãƒ¼æ•°: ${totalMarkers}\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: ${totalMarkers > 0 ? 'å¯èƒ½' : 'ä¸å¯'}\n\nF12ã‚­ãƒ¼ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚${turboLink}`);
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
        let isDebugModeActive = false;

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleDebugMode() {
            isDebugModeActive = !isDebugModeActive;
            const debugControls = document.getElementById('debug-controls');
            const toggleButton = event.target;
            
            if (isDebugModeActive) {
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
                `;
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ ON';
                toggleButton.style.background = '#28a745';
                console.log('ğŸ”§ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ - ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™', 'success');
            } else {
                debugControls.style.display = 'none';
                debugControls.innerHTML = '';
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰';
                toggleButton.style.background = '#6c757d';
                console.log('ğŸ”’ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ç¢ºèªã¨åˆæœŸåŒ–
        function initializeDebugMode() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚‚å¯¾å¿œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const isDebugMode = urlParams.get('debug') === 'true';
            
            if (isDebugMode) {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµŒç”±ã®å ´åˆã¯è‡ªå‹•ã§é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
                // toggleDebugModeé–¢æ•°ã‚’å‘¼ã³å‡ºã•ãšã«ç›´æ¥è¨­å®š
                isDebugModeActive = true;
                const debugControls = document.getElementById('debug-controls');
                const toggleButton = document.querySelector('.dev-mode-btn');
                
                debugControls.style.display = 'flex';
                debugControls.innerHTML = `
                    <button class="search-btn" onclick="showDebugInfo()" style="background: #95a5a6;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                    <button class="search-btn" onclick="jumpToTestLocation()" style="background: #e67e22;">ğŸ“ ãƒ†ã‚¹ãƒˆåœ°ç‚¹</button>
                    <button class="search-btn" onclick="testSimpleQuery()" style="background: #27ae60;">ğŸ§ª ç°¡å˜ãƒ†ã‚¹ãƒˆ</button>
                `;
                toggleButton.textContent = 'âš™ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ ON';
                toggleButton.style.background = '#28a745';
                console.log('ğŸ”§ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼ˆURLçµŒç”±ï¼‰');
                showStatus('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ï¼ˆURLçµŒç”±ï¼‰', 'success');
            }
        }

        // ä½ç½®æƒ…å ±å–å¾—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            // ä½ç½®æƒ…å ±å–å¾—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000 // 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 15);
                    showStatus('ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§åœ°å›³ã‚’ç§»å‹•ã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚';
                            break;
                        default:
                            errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                            break;
                    }
                    console.log('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', errorMessage);
                    // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã›ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬ï¼‰ã§é–‹å§‹
                },
                options
            );
        }

        // ä½ç½®æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ
        initializeLocation();
    </script>
</body>
</html>
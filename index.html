<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSM Infrastructure Viewer</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .header p {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .controls {
        background: white;
        padding: 1rem;
        margin: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .control-group label {
        font-weight: 500;
        color: #333;
      }

      .checkbox-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .checkbox-item input[type='checkbox'] {
        width: 16px;
        height: 16px;
        accent-color: #667eea;
      }

      .checkbox-item label {
        font-size: 0.9rem;
        color: #555;
        cursor: pointer;
      }

      .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .map-container {
        margin: 1rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }

      #map {
        height: 600px;
        width: 100%;
      }

      .status {
        margin: 1rem;
        padding: 0.8rem;
        border-radius: 6px;
        font-weight: 500;
        display: none;
      }

      .status.loading {
        background: #e3f2fd;
        color: #1976d2;
        border-left: 4px solid #2196f3;
        display: block;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
        display: block;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
        display: block;
      }

      .legend {
        background: white;
        padding: 1rem;
        margin: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .legend h3 {
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 1.1rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.3rem;
      }

      .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .marker-surveillance {
        background: #e74c3c;
      }
      .marker-tower {
        background: #3498db;
      }
      .marker-wifi {
        background: #f39c12;
      }

      @media (max-width: 768px) {
        .controls {
          margin: 0.5rem;
          padding: 0.8rem;
        }

        .checkbox-group {
          gap: 0.5rem;
        }

        .map-container {
          margin: 0.5rem;
        }

        #map {
          height: 500px;
        }

        .legend {
          margin: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ—ºï¸ OSM Infrastructure Viewer</h1>
      <p>
        OpenStreetMapã®ã‚¤ãƒ³ãƒ•ãƒ©ç³»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆCCTVã€åŸºåœ°å±€ã€Wi-Fiï¼‰ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«
      </p>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>è¡¨ç¤ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input
              type="checkbox"
              id="surveillance"
              value="surveillance"
              checked
            />
            <label for="surveillance">CCTVã‚«ãƒ¡ãƒ©</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="tower" value="tower" checked />
            <label for="tower">æºå¸¯åŸºåœ°å±€</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="wifi" value="wifi" checked />
            <label for="wifi">Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ</label>
          </div>
        </div>
      </div>
      <button class="search-btn" onclick="searchInfrastructure()">
        ğŸ” æ¤œç´¢
      </button>
    </div>

    <div class="status" id="status"></div>

    <div class="map-container">
      <div id="map"></div>
    </div>

    <div class="legend">
      <h3>å‡¡ä¾‹</h3>
      <div class="legend-item">
        <div class="legend-marker marker-surveillance"></div>
        <span>CCTVã‚«ãƒ¡ãƒ© (man_made=surveillance)</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-tower"></div>
        <span>æºå¸¯åŸºåœ°å±€ (man_made=communications_tower)</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-wifi"></div>
        <span>Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ (internet_access=wlan)</span>
      </div>
    </div>

    <div
      style="
        margin-top: 30px;
        padding: 15px;
        text-align: center;
        border-top: 1px solid #000000;
        color: #6c757d;
      "
    >
      ğŸ”— GitHubãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ï¼ˆ<a
        href="https://github.com/ipusiron/caesar-cipher-wheel"
        target="_blank"
        style="color: #007bff; text-decoration: none"
        >ipusiron/caesar-cipher-wheel</a
      >ï¼‰
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
      // åœ°å›³ã®åˆæœŸåŒ–
      let map = L.map('map').setView([35.6762, 139.6503], 13); // æ±äº¬é§…ä»˜è¿‘

      // OpenStreetMapã‚¿ã‚¤ãƒ«è¿½åŠ 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
      let markersGroup = L.layerGroup().addTo(map);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      function showStatus(message, type = 'loading') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type}`;

        if (type !== 'loading') {
          setTimeout(() => {
            status.style.display = 'none';
          }, 5000);
        }
      }

      // Overpass APIã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
      function buildOverpassQuery(bounds) {
        const selectedTypes = [];

        if (document.getElementById('surveillance').checked) {
          selectedTypes.push('man_made=surveillance');
        }
        if (document.getElementById('tower').checked) {
          selectedTypes.push('man_made=communications_tower');
        }
        if (document.getElementById('wifi').checked) {
          selectedTypes.push('internet_access=wlan');
        }

        if (selectedTypes.length === 0) {
          return null;
        }

        const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;

        let query = '[out:json][timeout:25];\n(\n';

        selectedTypes.forEach((type) => {
          if (type === 'internet_access=wlan') {
            query += `  node["${type}"](${bbox});\n`;
            query += `  way["${type}"](${bbox});\n`;
            query += `  relation["${type}"](${bbox});\n`;
          } else {
            query += `  node["${type}"](${bbox});\n`;
            query += `  way["${type}"](${bbox});\n`;
            query += `  relation["${type}"](${bbox});\n`;
          }
        });

        query += ');\nout geom;';

        return query;
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®š
      function getMarkerInfo(element) {
        const tags = element.tags || {};

        if (tags.man_made === 'surveillance') {
          return {
            color: '#e74c3c',
            icon: 'ğŸ“¹',
            type: 'CCTVã‚«ãƒ¡ãƒ©',
          };
        } else if (tags.man_made === 'communications_tower') {
          return {
            color: '#3498db',
            icon: 'ğŸ“¡',
            type: 'æºå¸¯åŸºåœ°å±€',
          };
        } else if (tags.internet_access === 'wlan') {
          return {
            color: '#f39c12',
            icon: 'ğŸ“¶',
            type: 'Wi-Fiãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ',
          };
        }

        return {
          color: '#95a5a6',
          icon: 'ğŸ“',
          type: 'ãã®ä»–',
        };
      }

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’ç”Ÿæˆ
      function generatePopupContent(element, markerInfo) {
        const tags = element.tags || {};
        let content = `<div style="min-width: 200px;">`;
        content += `<h4 style="margin: 0 0 10px 0; color: ${markerInfo.color};">${markerInfo.icon} ${markerInfo.type}</h4>`;

        // é‡è¦ãªå±æ€§ã‚’å„ªå…ˆè¡¨ç¤º
        const importantKeys = [
          'name',
          'operator',
          'surveillance:type',
          'tower:type',
          'height',
          'description',
        ];
        const displayedKeys = new Set();

        importantKeys.forEach((key) => {
          if (tags[key]) {
            content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
            displayedKeys.add(key);
          }
        });

        // ãã®ä»–ã®å±æ€§
        const otherTags = Object.keys(tags).filter(
          (key) => !displayedKeys.has(key)
        );
        if (otherTags.length > 0) {
          content += `<hr style="margin: 10px 0;">`;
          otherTags.forEach((key) => {
            if (key !== 'man_made' && key !== 'internet_access') {
              content += `<div><strong>${key}:</strong> ${tags[key]}</div>`;
            }
          });
        }

        content += `<hr style="margin: 10px 0;">`;
        content += `<div style="font-size: 0.8em; color: #666;">`;
        content += `<div>ID: ${element.id}</div>`;
        if (element.lat && element.lon) {
          content += `<div>ä½ç½®: ${element.lat.toFixed(
            6
          )}, ${element.lon.toFixed(6)}</div>`;
        }
        content += `</div></div>`;

        return content;
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
      function addMarkersToMap(data) {
        markersGroup.clearLayers();
        let count = 0;

        data.elements.forEach((element) => {
          let lat, lon;

          if (element.lat && element.lon) {
            lat = element.lat;
            lon = element.lon;
          } else if (element.center) {
            lat = element.center.lat;
            lon = element.center.lon;
          } else if (element.geometry && element.geometry.length > 0) {
            lat = element.geometry[0].lat;
            lon = element.geometry[0].lon;
          } else {
            return; // åº§æ¨™ãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          }

          const markerInfo = getMarkerInfo(element);

          // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: markerInfo.color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
          });

          const popupContent = generatePopupContent(element, markerInfo);
          marker.bindPopup(popupContent);

          markersGroup.addLayer(marker);
          count++;
        });

        showStatus(`${count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
      }

      // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’æ¤œç´¢
      async function searchInfrastructure() {
        const bounds = map.getBounds();
        const query = buildOverpassQuery(bounds);

        if (!query) {
          showStatus('æ¤œç´¢ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
          return;
        }

        showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'loading');

        const searchBtn = document.querySelector('.search-btn');
        searchBtn.disabled = true;
        searchBtn.textContent = 'æ¤œç´¢ä¸­...';

        try {
          const response = await fetch(
            'https://overpass-api.de/api/interpreter',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: 'data=' + encodeURIComponent(query),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          addMarkersToMap(data);
        } catch (error) {
          console.error('Error fetching data:', error);
          showStatus('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        } finally {
          searchBtn.disabled = false;
          searchBtn.textContent = 'ğŸ” æ¤œç´¢';
        }
      }

      // åœ°å›³ç§»å‹•æ™‚ã®å‡¦ç†
      map.on('moveend', function () {
        const zoom = map.getZoom();
        if (zoom < 10) {
          showStatus(
            'è©³ç´°ãªæ¤œç´¢ã«ã¯åœ°å›³ã‚’ã‚ˆã‚Šæ‹¡å¤§ã—ã¦ãã ã•ã„ï¼ˆã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«10ä»¥ä¸Šæ¨å¥¨ï¼‰',
            'error'
          );
        }
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      window.addEventListener('load', function () {
        showStatus(
          'åœ°å›³ã‚’ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ ã—ã¦ã‹ã‚‰æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„',
          'success'
        );
      });

      // ä½ç½®æƒ…å ±å–å¾—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      function initializeLocation() {
        if (!navigator.geolocation) {
          console.log('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
          return;
        }

        // ä½ç½®æƒ…å ±å–å¾—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const options = {
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 600000, // 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
        };

        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            map.setView([lat, lon], 15);
            showStatus('ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
          },
          function (error) {
            let errorMessage = '';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage =
                  'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§åœ°å›³ã‚’ç§»å‹•ã—ã¦ãã ã•ã„ã€‚';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                break;
              case error.TIMEOUT:
                errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚';
                break;
              default:
                errorMessage = 'ä½ç½®æƒ…å ±ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                break;
            }
            console.log('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', errorMessage);
            // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã›ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬ï¼‰ã§é–‹å§‹
          },
          options
        );
      }

      // ä½ç½®æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ
      initializeLocation();
    </script>
  </body>
</html>
